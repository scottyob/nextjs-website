<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/2aaf0723e720e8b9-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/42e58f5a516ebb1b-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/4c1c321c249fa2d1-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/8679c800f1e60000-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/0d26c7c4f71e78d1.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/99e3bcfff854f17e.css" data-precedence="next"/><title>Scott O&#x27;Brien</title><meta name="description" content="My online creative outlet"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_0ec1f4"><div class="flex max-w-full w-full flex-col pt-8 pb-8"><div class="self-center w-full"><h1 class="text-center text-4xl __className_baad2a"><a href="/">Scott O&#x27;Brien</a></h1><ul class="flex flex-wrap justify-center space-x-2 text-gray-400 italic pt-3 mb-8 max-w-2xl w-[80%] m-auto __className_6cf34a"><li class="transition group duration-300 whitespace-nowrap"><a href="/">Writings/Projects</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-[70%] bg-orange-500"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/about/">About</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/bucketlist/">Bucket List</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/recipes/">Cooking</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/flying/">Flying</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li></ul></div><div class="w-full flex flex-col" id="main-content"><div class="self-center mt-7 max-w-2xl w-[80%]"><article class=""><div class="__className_2e19ce mb-9"><h2 class="__className_59b087 text-2xl">High Availability WordPress LAMP Stack.</h2><div class="text-xs text-gray-400 italic mb-5">Created: <span>4/13/2012, 7:27:11 AM</span></div><div class="prose lg:prose-lg"><p>In one of my last little tasks at work, I was asked to eliminate single points of failure in the software and hardware stack without spending a fortune on hardware or software licenses. During the process of ensuring high availability (HA), I realized that many small companies might have similar need, but with more pressing tasks and limited man hours, without a post that talks about all the issues and solutions in one place, many companies and organisations tend to leave single points of failure living with the chance that they’re not going to fail any time soon.</p>
<!-- -->
<p>I’ve wanted to write this blog post for a while. After you’ve finished reading this blog post, you should have the knowledge to be able to eliminate the single point of failures in hosting a WordPress website. While I’ve chosen WordPress to be the demonstration of this post, the concepts will work with any apache/mysql LAMP stack software. During the course of this tutorial, I’ll run you through it in two parts. The first part is talking about setting up the physical hosts and topology (using Juniper EX2200 switches, SRX100 border firewall’s and ESXi (free) hypervisors for the software stack.) The second part is talking about setting up the software stack to deliver our LAMP stack in a highly redundant fashion.  However what I won&#x27;t be doing is providing complete configuration examples.  Instead, please consider this post as an overview to help enlighten you and link you to more specific information to help you set this up in your own environment.</p>
<p>This blog post is split up in two parts, this first post in the series talks about setting up the network infrastructure, the second talks about setting up the software stack.</p>
<p>Part 1 (physical topology)</p>
<ul>
<li>Network overview</li>
<li>Setting up dual Switches</li>
<li>Setting up ESXi network cards.</li>
<li>Setting up SRX border firewall’s.</li>
</ul>
<p>Part 2 (software stack)</p>
<ul>
<li>Nginx load balancing proxy</li>
<li>Web Servers.</li>
<li>NFS File Server</li>
<li>MySQL cluster.</li>
</ul>
<h3>Part 1, Physical Topology</h3>
<p>If you’re reading this, I’m guessing your current network topology looks something like</p>
<p>mine used to.  You have a single internet connection, single router/firewall, single switch and a bunch of hosts hanging from that switch.  In the event of a system failure, your system administrator (me in this case) will have to hop in a cab and rush to the server room to fix the problem.</p>
<img src="/posts/2012/ha-system-network/Old-Network-1-3ZGHFJMC.jpg" alt="Old network topology"/>
<p>The goal with this tutorial is to attempt to help your administrators sleep at night.  We will eliminate every single point of failure such that in the event of a system outage/failure, the system can self recover with at most a minute of unscheduled down time.</p>
<img src="/posts/2012/ha-system-network/New-Network-NS2YFXOF.jpg" alt="Old network topology"/>
<h4>Physical Switches</h4>
<p>We’ll be replacing the single switch (in my case, unmanaged old gigabit switch) with a pair of managed switches.  Because our bandwidth requirements in this site wasn’t terribly demanding (simple database server, few web, mail servers and the like), a single gigabit Ethernet link to all hosts was all that we required.  If you’re in the same boat I was, I can suggest a pair of Juniper EX2200’s.  If however, you’re going to be pumping some more bandwidth intensive applications through your network (thus require more then gigabit Ethernet connections to the hosts) or have the need for more then a single VLAN and intra-VLAN routing is required (that’s all outside the scope of this tutorial.)  I can strongly recommend you start looking at the EX4200 model switches (set up in a virtual chassis), which can do all your highly available layer 3 IP routing and support multi gigabit Ethernet to your hosts by spanning Ethernet channel across both physical switches.</p>
<h4>Active/Passive Switch Design?</h4>
<p>Ok, so this heading is a lie, but let me explain.  In my switch design with the EX2200’s, I’m using aggregate Ethernet 802.3ad Etherchannel between my two switches. I’ve opted to use 4 physical ports in my 24 port switches (ge-0/0/20 to ge-0/0/23) to give me a 4Gbit/s backbone between them. Obviously with gigabit Ethernet right through the network this isn’t much bandwidth, so the idea is to keep as little data traveling that link as possible (network broadcasts only hopefully!)</p>
<p>First, the following configuration configures the aggregate Ethernet link between the switches:</p>
<pre><code>chassis {
  aggregated-devices {
    ethernet {
      device-count 1;
    }
  }
}

[interfaces]
ge-0/0/20 {
  ether-options {
    802.3ad ae0;
  }
}
ge-0/0/21 {
  ether-options {
    802.3ad ae0;
  }
}
ge-0/0/22 {
  ether-options {
    802.3ad ae0;
  }
}
ge-0/0/23 {
  ether-options {
    802.3ad ae0;
  }
}

ae0 {
  aggregated-ether-options {
    lacp {
      passive;
    }
  }
  unit 0 {
    family ethernet-switching {
      port-mode trunk;
      vlan {
        members all;
      }
    }
  }
}
</code></pre>
<p>The only thing you have to watch out for, is that on at least one switch, you set the lacp mode to be <strong>active</strong>.</p>
<h4>Setting up ESXi Network</h4>
<p>In my environment, I’m using the free version of ESXi 4.1. I understand that you may wish to be connecting linux hosts directly. If you’re directly connecting linux hosts, I recommend you look at creating a <a href="http://wiki.centos.org/TipsAndTricks/BondingInterfaces">Bonding Adaptor</a>.  Thought without the more expensive EX4200’s, we’re best sticking with an active-backup setup and should stick with mode=1.</p>
<p>For the ESXi configuration, it’s pretty simple. We connect two NIC’s to the switches. A primary NIC to the primary switch, and a secondary NIC to the secondary switch.</p>
<p>The steps on configuring the vSwitch (virtual switch) are pretty simple. Virtual machines on these ESXi hosts won’t have to do anything special once this setup has been done to take advantage on the physical machines, they’ll just take advantage of our HA network topology.</p>
<p>First, ensure that we have two NIC’s setup on our vSwitch.</p>
<img src="/posts/2012/ha-system-network/vSwitch-F7EOMMHW.jpg" alt="vSwitch design"/>
<p>Next, look at the following configuration properties I’ve made to the NIC teaming information.  This basic configuration will ensure that when the link on vmnic0 is available (our active switch), it’ll use it.  When the link becomes unavailable, it will fail over to vmnic1.</p>
<img src="/posts/2012/ha-system-network/vSwitch-1-U4HIYECV.jpg" alt="vSwitch config"/>
<h5>Setting up border firewall’s</h5>
<p>The last step we’ve got in our highly available infrastructure here is our border firewall’s. Please bare with me on this section, it is the most complicated and there are a few technologies introduced. If there is something I don’t explain completely, please feel free to leave a comment below and I’ll try and explain it better.  I expect you’ll have to jump back and forth between Wikipedia and this article to fully understand what it is we’re doing. Explaining the concepts behind BGP and autonomous systems is beyond the scope of this article.</p>
<p>In my role, I replaced an active/backup GNU based firewall solution (backup being run down to the data center as fast as possible and swap the cables over) with two Juniper SRX100’s configured in an active/passive configuration under a chassis cluster (see SRX100 high availability deployment guide at <a href="http://kb.juniper.net/InfoCenter/index?page=content&amp;id=KB15669">http://kb.juniper.net/InfoCenter/index?page=content&amp;id=KB15669</a>). We had get a second internet connection installed, then make sure that any one link (or firewall itself) can die and still have the system self recover. There are two major tasks that has to happen to make this gateway highly available. Firstly, our internal network hosts will be using one of these firewall’s as their default gateway. If the link to the primary switch, or the primary firewall itself should die, we still want the network hosts to be able to reach their gateway. We will achieve this with “redundant Ethernet” on the cluster. If you’ve come from the cisco networking world before, picture something like this to be like VRRP for the inside hosts. If the main link fails, the MAC and IP address will float over to the other physical port.</p>
<p>Let me give a bit more detail to our new example network topology here in this example so you can gain a better idea of how these settings work.</p>
<img src="/posts/2012/ha-system-network/Network-Setup-OIDB3MBW.jpg" alt="Network topology"/>
<p>For the internal gateway address to fail over to the other switch should your link off Firewall1 die, You’ll want to make the following configuration</p>
<pre><code>chassis {
  cluster {
    reth-count 2;
    redundancy-group 0 {
      node 0 priority 100;
      node 1 priority 1;
    }
    redundancy-group 1 {
      node 0 priority 254;
      node 1 priority 1;
      preempt;
      interface-monitor {
        fe-0/0/1 weight 255;
        fe-1/0/1 weight 255;
      }
    }
  }
}

interfaces {
  fe-0/0/1 {
    fastether-options {
      redundant-parent reth1;
    }
  }
  fe-1/0/1 {
    fastether-options {
      redundant-parent reth1;
    }
  }
}
</code></pre>
<p>You can see redundancy-group 1 is monitoring the local interfaces going back to the switches.</p>
<p>For the dual WAN links, I won’t go into much detail, but you’ll want to ask your ISP for a second internet connection. Some providers offer a cheap link that they only charge you for once you start flowing data over it (sometimes called a Shadow link). This is perfect as you can flow all your traffic through your primary internet connection, then on failure of it, you’ll move your traffic through the secondary. If you wanted complete redundancy, you could apply for a domain independent subnet (has to be a class C to advertise on world BGP tables) and your own ASN. This will let you use two different internet service providers.</p>
<p>In my case, I’m creating a redundant connection using the same ISP, so I’ve asked for a private ASN to be allocated (see http://en.wikipedia.org/wiki/Autonomous_System_(Internet) ).</p>
<p>For a small network such as ours (especially using the small base level SRX’s) you’ll want to ask your provider to advertise only the default route to you. In turn, you’ll advertise your network’s address space on both connections. On the event that a link dies, the BGP peer on the other end no longer receives updates from you and will no longer attempt to route to it.</p>
<p>The following configuration extract shows how we’d configure out SRX firewall’s to peer with our ISP’s routers. Things of note is that our primary link (the one on the left) has a lower metric-out then the shadow link, meaning a lower MED attribute is sent to our ISP and thus inbound traffic will, by preference use the main connection. The preference values under neighbor will determine the preference we will send traffic under that connection for outbound traffic.</p>
<pre><code>routing-options {
  autonomous-system 64512;
}

protocols {
  bgp {
    group ISP {
      metric-out 50;
      local-address 1.1.1.2;
      import ISP-in;
      export ISP-out;
      neighbor 1.1.1.1 {
        preference 170;
        peer-as 123;
      }
    }
    group ISP-shadow {
      metric-out 100;
      local-address 1.1.1.6;
      import ISP-in;
      export ISP-out;
      neighbor 1.1.1.5 {
        preference 180;
        peer-as 123;
      }
    }
  }
}

policy-options {
  policy-statement ISP-in {
    term default-in {
      from {
        route-filter 0.0.0.0/0 exact;
      }
      then accept;
    }
    term block {
      then reject;
    }
  }
  policy-statement ISP-out {
    term tnziPublic {
      from {
        protocol direct;
        route-filter 2.2.2.0/26 exact;
      }
      then accept;
    }
  }
}
</code></pre></div></div></article></div></div></div><script src="/_next/static/chunks/webpack-f503b2c49e415ac7.js" async=""></script><script src="/_next/static/chunks/bce60fc1-e7cb3874f5f47943.js" async=""></script><script src="/_next/static/chunks/488-f907c6837e991d02.js" async=""></script><script src="/_next/static/chunks/main-app-fd28149d965ecf3e.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/2aaf0723e720e8b9-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/42e58f5a516ebb1b-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/css/0d26c7c4f71e78d1.css\",{\"as\":\"style\"}]\n0:\"$L5\"\n"])</script><script>self.__next_f.push([1,"6:HL[\"/_next/static/media/4c1c321c249fa2d1-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n7:HL[\"/_next/static/media/8679c800f1e60000-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n8:HL[\"/_next/static/css/99e3bcfff854f17e.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"9:I{\"id\":\"8827\",\"chunks\":[\"272:static/chunks/webpack-f503b2c49e415ac7.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"488:static/chunks/488-f907c6837e991d02.js\"],\"name\":\"\",\"async\":false}\nb:I{\"id\":\"9126\",\"chunks\":[\"272:static/chunks/webpack-f503b2c49e415ac7.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"488:static/chunks/488-f907c6837e991d02.js\"],\"name\":\"\",\"async\":false}\nc:I{\"id\":\"8920\",\"chunks\":[\"920:static/chunks/920-beeca0bfb1d2369e.js\",\"348:static/chunks/348-700824deec928208.js\",\"304:static/"])</script><script>self.__next_f.push([1,"chunks/304-79fa6ad07eecf6c9.js\",\"534:static/chunks/app/flying/location/[slug]/page-1764d82524f789b4.js\"],\"name\":\"\",\"async\":false}\nd:I{\"id\":\"558\",\"chunks\":[\"920:static/chunks/920-beeca0bfb1d2369e.js\",\"185:static/chunks/app/layout-33994cd5ee6d865f.js\"],\"name\":\"\",\"async\":false}\nf:I{\"id\":\"4463\",\"chunks\":[\"272:static/chunks/webpack-f503b2c49e415ac7.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"488:static/chunks/488-f907c6837e991d02.js\"],\"name\":\"\",\"async\":false}\n10:I{\"id\":\"1010\",\"chunks\":[\"272:static/chun"])</script><script>self.__next_f.push([1,"ks/webpack-f503b2c49e415ac7.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"488:static/chunks/488-f907c6837e991d02.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0d26c7c4f71e78d1.css\",\"precedence\":\"next\"}]],[\"$\",\"$L9\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/2012/ha-system-network/\",\"initialTree\":[\"\",{\"children\":[\"(margined)\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"2012/ha-system-network\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"2012\\\",\\\"ha-system-network\\\"]}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$La\",[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]],\"globalErrorComponent\":\"$b\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_0ec1f4\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_baad2a\",\"children\":[\"$\",\"$Lc\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$Ld\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$Le\",\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}]]}]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_0ec1f4\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_baad2a\",\"children\":[\"$\",\"$Lc\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$Ld\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"div\",null,{\"className\":\"self-center mt-7 max-w-2xl w-[80%]\",\"children\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\",\"post\",\"children\",[\"slug\",\"2012/ha-system-network\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L11\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"2012\\\",\\\"ha-system-network\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/99e3bcfff854f17e.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"2012/ha-system-network\",\"c\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}]}],null],\"segment\":\"(margined)\"},\"styles\":[]}]}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Scott O'Brien\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"My online creative outlet\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]]\n"])</script><script>self.__next_f.push([1,"12:I{\"id\":\"8288\",\"chunks\":[\"707:static/chunks/707-e3070078e72f1aa2.js\",\"726:static/chunks/app/(margined)/post/[...slug]/page-824ad804da7b0d15.js\"],\"name\":\"\",\"async\":false}\n13:I{\"id\":\"2853\",\"chunks\":[\"91:static/chunks/app/flying/flight/[slug]/page-96287e22abdff0cd.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"11:[\"$\",\"article\",null,{\"className\":\"\",\"children\":[\"$\",\"div\",null,{\"className\":\"__className_2e19ce mb-9\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"__className_59b087 text-2xl\",\"children\":\"High Availability WordPress LAMP Stack.\"}],[\"$\",\"div\",null,{\"className\":\"text-xs text-gray-400 italic mb-5\",\"children\":[\"Created: \",[\"$\",\"$L12\",null,{\"date\":\"$D2012-04-13T07:27:11.000Z\"}]]}],\"$undefined\",[\"$\",\"div\",null,{\"className\":\"prose lg:prose-lg\",\"children\":[\"$\",\"$L13\",null,{\"code\":\"var Component=(()=\u003e{var m=Object.create;var n=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var P=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var l=(e,E)=\u003e()=\u003e(E||e((E={exports:{}}).exports,E),E.exports),w=(e,E)=\u003e{for(var o in E)n(e,o,{get:E[o],enumerable:!0})},r=(e,E,o,t)=\u003e{if(E\u0026\u0026typeof E==\\\"object\\\"||typeof E==\\\"function\\\")for(let i of g(E))!G.call(e,i)\u0026\u0026i!==o\u0026\u0026n(e,i,{get:()=\u003eE[i],enumerable:!(t=u(E,i))||t.enumerable});return e};var W=(e,E,o)=\u003e(o=e!=null?m(P(e)):{},r(E||!e||!e.__esModule?n(o,\\\"default\\\",{value:e,enumerable:!0}):o,e)),Z=e=\u003er(n({},\\\"__esModule\\\",{value:!0}),e);var k=l(($,s)=\u003e{s.exports=_jsx_runtime});var q={};w(q,{default:()=\u003eF,frontmatter:()=\u003eY});var Q=W(k());var h=\\\"/posts/2012/ha-system-network/Old-Network-1-3ZGHFJMC.jpg\\\";var _=\\\"/posts/2012/ha-system-network/New-Network-NS2YFXOF.jpg\\\";var c=\\\"/posts/2012/ha-system-network/vSwitch-F7EOMMHW.jpg\\\";var O=\\\"/posts/2012/ha-system-network/vSwitch-1-U4HIYECV.jpg\\\";var a=\\\"/posts/2012/ha-system-network/Network-Setup-OIDB3MBW.jpg\\\";var Y={title:\\\"High Availability WordPress LAMP Stack.\\\",author:\\\"scottyob\\\",type:\\\"post\\\",date:new Date(1334302031e3),url:\\\"/2012/04/13/ha-network/\\\",categories:[\\\"nerd\\\"],tags:[\\\"Hardware\\\",\\\"Juniper\\\",\\\"Networking\\\",\\\"SRX\\\",\\\"VMWare\\\"],hero:\\\"New-Network.jpg\\\",hideHero:!0};function x(e){let E=Object.assign({p:\\\"p\\\",ul:\\\"ul\\\",li:\\\"li\\\",h3:\\\"h3\\\",h4:\\\"h4\\\",pre:\\\"pre\\\",code:\\\"code\\\",strong:\\\"strong\\\",a:\\\"a\\\",h5:\\\"h5\\\"},e.components);return(0,Q.jsxs)(Q.Fragment,{children:[(0,Q.jsx)(E.p,{children:\\\"In one of my last little tasks at work, I was asked to eliminate single points of failure in the software and hardware stack without spending a fortune on hardware or software licenses. During the process of ensuring high availability (HA), I realized that many small companies might have similar need, but with more pressing tasks and limited man hours, without a post that talks about all the issues and solutions in one place, many companies and\\\\xA0organisations\\\\xA0tend to leave single points of failure living with the chance that they\\\\u2019re not going to fail any time soon.\\\"}),`\\n`,`\\n`,(0,Q.jsx)(E.p,{children:\\\"I\\\\u2019ve wanted to write this blog post for a while. After you\\\\u2019ve finished reading this blog post, you should have the knowledge to be able to eliminate the single point of failures in hosting a WordPress website. While I\\\\u2019ve chosen WordPress to be the demonstration of this post, the concepts will work with any apache/mysql LAMP stack software. During the course of this tutorial, I\\\\u2019ll run you through it in two parts. The first part is talking about setting up the physical hosts and topology (using Juniper EX2200 switches, SRX100 border firewall\\\\u2019s and ESXi (free) hypervisors for the software stack.) The second part is talking about setting up the software stack to deliver our LAMP stack in a highly redundant fashion. \\\\xA0However what I won't be doing is providing complete configuration examples. \\\\xA0Instead, please consider this post as an overview to help enlighten you and link you to more specific information to help you set this up in your own environment.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"This blog post is split up in two parts, this first post in the series talks about setting up the network infrastructure, the second talks about setting up the software stack.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"Part 1 (physical topology)\\\"}),`\\n`,(0,Q.jsxs)(E.ul,{children:[`\\n`,(0,Q.jsx)(E.li,{children:\\\"Network overview\\\"}),`\\n`,(0,Q.jsx)(E.li,{children:\\\"Setting up dual Switches\\\"}),`\\n`,(0,Q.jsx)(E.li,{children:\\\"Setting up ESXi network cards.\\\"}),`\\n`,(0,Q.jsx)(E.li,{children:\\\"Setting up SRX border firewall\\\\u2019s.\\\"}),`\\n`]}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"Part 2 (software stack)\\\"}),`\\n`,(0,Q.jsxs)(E.ul,{children:[`\\n`,(0,Q.jsx)(E.li,{children:\\\"Nginx load balancing proxy\\\"}),`\\n`,(0,Q.jsx)(E.li,{children:\\\"Web Servers.\\\"}),`\\n`,(0,Q.jsx)(E.li,{children:\\\"NFS File Server\\\"}),`\\n`,(0,Q.jsx)(E.li,{children:\\\"MySQL cluster.\\\"}),`\\n`]}),`\\n`,(0,Q.jsx)(E.h3,{children:\\\"Part 1, Physical Topology\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"If you\\\\u2019re reading this, I\\\\u2019m guessing your current network topology looks something like\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"mine used to. \\\\xA0You have a single internet connection, single router/firewall, single switch and a bunch of hosts hanging from that switch. \\\\xA0In the event of a system failure, your system administrator (me in this case) will have to hop in a cab and rush to the server room to fix the problem.\\\"}),`\\n`,(0,Q.jsx)(\\\"img\\\",{src:h,alt:\\\"Old network topology\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"The goal with this tutorial is to attempt to help your administrators sleep at night. \\\\xA0We will eliminate every single point of failure such that in the event of a system outage/failure, the system can self recover with at most a minute of unscheduled down time.\\\"}),`\\n`,(0,Q.jsx)(\\\"img\\\",{src:_,alt:\\\"Old network topology\\\"}),`\\n`,(0,Q.jsx)(E.h4,{children:\\\"Physical Switches\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"We\\\\u2019ll be replacing the single switch (in my case, unmanaged old gigabit switch) with a pair of managed switches. \\\\xA0Because our bandwidth requirements in this site wasn\\\\u2019t terribly demanding (simple database server, few web, mail servers and the like), a single gigabit Ethernet link to all hosts was all that we required. \\\\xA0If you\\\\u2019re in the same boat I was, I can suggest a pair of Juniper EX2200\\\\u2019s. \\\\xA0If however, you\\\\u2019re going to be pumping some more bandwidth intensive applications through your network (thus require more then gigabit Ethernet connections to the hosts) or have the need for more then a single VLAN and intra-VLAN routing is required (that\\\\u2019s all outside the scope of this tutorial.) \\\\xA0I can strongly recommend you start looking at the EX4200 model switches (set up in a virtual chassis), which can do all your highly available layer 3 IP routing and support multi gigabit Ethernet to your hosts by spanning Ethernet channel across both physical switches.\\\"}),`\\n`,(0,Q.jsx)(E.h4,{children:\\\"Active/Passive Switch Design?\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"Ok, so this heading is a lie, but let me explain. \\\\xA0In my switch design with the EX2200\\\\u2019s, I\\\\u2019m using aggregate Ethernet 802.3ad Etherchannel between my two switches. I\\\\u2019ve opted to use 4 physical ports in my 24 port switches (ge-0/0/20 to ge-0/0/23) to give me a 4Gbit/s backbone between them. Obviously with gigabit Ethernet right through the network this isn\\\\u2019t much bandwidth, so the idea is to keep as little data traveling that link as possible (network broadcasts only hopefully!)\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"First, the following configuration configures the aggregate Ethernet link between the switches:\\\"}),`\\n`,(0,Q.jsx)(E.pre,{children:(0,Q.jsx)(E.code,{children:`chassis {\\n  aggregated-devices {\\n    ethernet {\\n      device-count 1;\\n    }\\n  }\\n}\\n\\n[interfaces]\\nge-0/0/20 {\\n  ether-options {\\n    802.3ad ae0;\\n  }\\n}\\nge-0/0/21 {\\n  ether-options {\\n    802.3ad ae0;\\n  }\\n}\\nge-0/0/22 {\\n  ether-options {\\n    802.3ad ae0;\\n  }\\n}\\nge-0/0/23 {\\n  ether-options {\\n    802.3ad ae0;\\n  }\\n}\\n\\nae0 {\\n  aggregated-ether-options {\\n    lacp {\\n      passive;\\n    }\\n  }\\n  unit 0 {\\n    family ethernet-switching {\\n      port-mode trunk;\\n      vlan {\\n        members all;\\n      }\\n    }\\n  }\\n}\\n`})}),`\\n`,(0,Q.jsxs)(E.p,{children:[\\\"The only thing you have to watch out for, is that on at least one switch, you set the lacp mode to be \\\",(0,Q.jsx)(E.strong,{children:\\\"active\\\"}),\\\".\\\"]}),`\\n`,(0,Q.jsx)(E.h4,{children:\\\"Setting up ESXi Network\\\"}),`\\n`,(0,Q.jsxs)(E.p,{children:[\\\"In my environment, I\\\\u2019m using the free version of ESXi 4.1. I understand that you may wish to be connecting linux hosts directly. If you\\\\u2019re directly connecting linux hosts, I recommend you look at creating a \\\",(0,Q.jsx)(E.a,{href:\\\"http://wiki.centos.org/TipsAndTricks/BondingInterfaces\\\",children:\\\"Bonding Adaptor\\\"}),\\\".\\\\xA0 Thought without the more expensive EX4200\\\\u2019s, we\\\\u2019re best sticking with an active-backup setup and should stick with mode=1.\\\"]}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"For the ESXi configuration, it\\\\u2019s pretty simple. We connect two NIC\\\\u2019s to the switches. A primary NIC to the primary switch, and a secondary NIC to the secondary switch.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"The steps on configuring the vSwitch (virtual switch) are pretty simple. Virtual machines on these ESXi hosts won\\\\u2019t have to do anything special once this setup has been done to take advantage on the physical machines, they\\\\u2019ll just take advantage of our HA network topology.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"First, ensure that we have two NIC\\\\u2019s setup on our vSwitch.\\\"}),`\\n`,(0,Q.jsx)(\\\"img\\\",{src:c,alt:\\\"vSwitch design\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"Next, look at the following configuration properties I\\\\u2019ve made to the NIC teaming information. \\\\xA0This basic configuration will ensure that when the link on vmnic0 is available (our active switch), it\\\\u2019ll use it. \\\\xA0When the link becomes unavailable, it will fail over to vmnic1.\\\"}),`\\n`,(0,Q.jsx)(\\\"img\\\",{src:O,alt:\\\"vSwitch config\\\"}),`\\n`,(0,Q.jsx)(E.h5,{children:\\\"Setting up border firewall\\\\u2019s\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"The last step we\\\\u2019ve got in our highly available infrastructure here is our border firewall\\\\u2019s. Please bare with me on this section, it is the most complicated and there are a few technologies introduced. If there is something I don\\\\u2019t explain completely, please feel free to leave a comment below and I\\\\u2019ll try and explain it better. \\\\xA0I expect you\\\\u2019ll have to jump back and forth between Wikipedia and this article to fully understand what it is we\\\\u2019re doing. Explaining the concepts behind BGP and autonomous systems is beyond the scope of this article.\\\"}),`\\n`,(0,Q.jsxs)(E.p,{children:[\\\"In my role, I replaced an active/backup GNU based firewall solution (backup being run down to the data center as fast as possible and swap the cables over) with two Juniper SRX100\\\\u2019s configured in an active/passive configuration under a chassis cluster (see SRX100 high availability deployment guide at \\\",(0,Q.jsx)(E.a,{href:\\\"http://kb.juniper.net/InfoCenter/index?page=content\u0026id=KB15669\\\",children:\\\"http://kb.juniper.net/InfoCenter/index?page=content\u0026id=KB15669\\\"}),\\\"). We had get a second internet connection installed, then make sure that any one link (or firewall itself) can die and still have the system self recover. There are two major tasks that has to happen to make this gateway highly available. Firstly, our internal network hosts will be using one of these firewall\\\\u2019s as their default gateway. If the link to the primary switch, or the primary firewall itself should die, we still want the network hosts to be able to reach their gateway. We will achieve this with \\\\u201Credundant Ethernet\\\\u201D on the cluster. If you\\\\u2019ve come from the cisco networking world before, picture something like this to be like VRRP for the inside hosts. If the main link fails, the MAC and IP address will float over to the other physical port.\\\"]}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"Let me give a bit more detail to our new example network topology here in this example so you can gain a better idea of how these settings work.\\\"}),`\\n`,(0,Q.jsx)(\\\"img\\\",{src:a,alt:\\\"Network topology\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"For the internal gateway address to fail over to the other switch should your link off Firewall1 die, You\\\\u2019ll want to make the following configuration\\\"}),`\\n`,(0,Q.jsx)(E.pre,{children:(0,Q.jsx)(E.code,{children:`chassis {\\n  cluster {\\n    reth-count 2;\\n    redundancy-group 0 {\\n      node 0 priority 100;\\n      node 1 priority 1;\\n    }\\n    redundancy-group 1 {\\n      node 0 priority 254;\\n      node 1 priority 1;\\n      preempt;\\n      interface-monitor {\\n        fe-0/0/1 weight 255;\\n        fe-1/0/1 weight 255;\\n      }\\n    }\\n  }\\n}\\n\\ninterfaces {\\n  fe-0/0/1 {\\n    fastether-options {\\n      redundant-parent reth1;\\n    }\\n  }\\n  fe-1/0/1 {\\n    fastether-options {\\n      redundant-parent reth1;\\n    }\\n  }\\n}\\n`})}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"You can see redundancy-group 1 is monitoring the local interfaces going back to the switches.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"For the dual WAN links, I won\\\\u2019t go into much detail, but you\\\\u2019ll want to ask your ISP for a second internet connection. Some providers offer a cheap link that they only charge you for once you start flowing data over it (sometimes called a Shadow link). This is perfect as you can flow all your traffic through your primary internet connection, then on failure of it, you\\\\u2019ll move your traffic through the secondary. If you wanted complete redundancy, you could apply for a domain independent subnet (has to be a class C to advertise on world BGP tables) and your own ASN. This will let you use two different internet service providers.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"In my case, I\\\\u2019m creating a redundant connection using the same ISP, so I\\\\u2019ve asked for a private ASN to be allocated (see http://en.wikipedia.org/wiki/Autonomous_System_(Internet) ).\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"For a small network such as ours (especially using the small base level SRX\\\\u2019s) you\\\\u2019ll want to ask your provider to advertise only the default route to you. In turn, you\\\\u2019ll advertise your network\\\\u2019s address space on both connections. On the event that a link dies, the BGP peer on the other end no longer receives updates from you and will no longer attempt to route to it.\\\"}),`\\n`,(0,Q.jsx)(E.p,{children:\\\"The following configuration extract shows how we\\\\u2019d configure out SRX firewall\\\\u2019s to peer with our ISP\\\\u2019s routers. Things of note is that our primary link (the one on the left) has a lower metric-out then the shadow link, meaning a lower MED attribute is sent to our ISP and thus inbound traffic will, by preference use the main connection. The preference values under neighbor will determine the preference we will send traffic under that connection for outbound traffic.\\\"}),`\\n`,(0,Q.jsx)(E.pre,{children:(0,Q.jsx)(E.code,{children:`routing-options {\\n  autonomous-system 64512;\\n}\\n\\nprotocols {\\n  bgp {\\n    group ISP {\\n      metric-out 50;\\n      local-address 1.1.1.2;\\n      import ISP-in;\\n      export ISP-out;\\n      neighbor 1.1.1.1 {\\n        preference 170;\\n        peer-as 123;\\n      }\\n    }\\n    group ISP-shadow {\\n      metric-out 100;\\n      local-address 1.1.1.6;\\n      import ISP-in;\\n      export ISP-out;\\n      neighbor 1.1.1.5 {\\n        preference 180;\\n        peer-as 123;\\n      }\\n    }\\n  }\\n}\\n\\npolicy-options {\\n  policy-statement ISP-in {\\n    term default-in {\\n      from {\\n        route-filter 0.0.0.0/0 exact;\\n      }\\n      then accept;\\n    }\\n    term block {\\n      then reject;\\n    }\\n  }\\n  policy-statement ISP-out {\\n    term tnziPublic {\\n      from {\\n        protocol direct;\\n        route-filter 2.2.2.0/26 exact;\\n      }\\n      then accept;\\n    }\\n  }\\n}\\n`})})]})}function z(e={}){let{wrapper:E}=e.components||{};return E?(0,Q.jsx)(E,Object.assign({},e,{children:(0,Q.jsx)(x,e)})):x(e)}var F=z;return Z(q);})();\\n;return Component;\"}]}]]}]}]\n"])</script></body></html>