<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/42e58f5a516ebb1b-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/d45575ed0ad4f563-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/8679c800f1e60000-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/af1939b13935fec8-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/70a6988bfc142772.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/d699b3284dd0f0c8.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/e1665b43251c86eb.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-c0d6ce99d471eac9.js" as="script"/><link rel="preload" href="/_next/static/chunks/fd9d1056-f562485b1666a0a3.js" as="script"/><link rel="preload" href="/_next/static/chunks/596-5b64dbf019a905f5.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-app-c71b577ad5f96a17.js" as="script"/><title>Scott O&#x27;Brien</title><meta name="description" content="My online creative outlet"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_e66fe9"><div class="flex max-w-full w-full flex-col pt-8 pb-8"><div class="self-center w-full"><h1 class="text-center text-4xl __className_31da3a"><a href="/">Scott O&#x27;Brien</a></h1><ul class="flex flex-wrap justify-center text-gray-400 italic pt-3 mb-8 max-w-2xl w-[80%] m-auto [&amp;&gt;li]:ml-3 [&amp;&gt;li]:mr-3 [&amp;_svg]:inline [&amp;_svg]:mr-1 __className_7febbd"><li class="transition group duration-300 whitespace-nowrap"><a href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" version="1.1" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 10l2-1 7-7-1-1-7 7-1 2zM4.52 13.548c-0.494-1.043-1.026-1.574-2.069-2.069l1.548-4.262 2-1.217 6-6h-3l-6 6-3 10 10-3 6-6v-3l-6 6-1.217 2z"></path></svg>Writings/Projects</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-[85%] bg-orange-500"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/about/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" version="1.1" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9 1.5c0 0.828-0.672 1.5-1.5 1.5s-1.5-0.672-1.5-1.5c0-0.828 0.672-1.5 1.5-1.5s1.5 0.672 1.5 1.5z"></path><path d="M9 4h-3c-0.552 0-1 0.448-1 1v5h1v6h1.25v-6h0.5v6h1.25v-6h1v-5c0-0.552-0.448-1-1-1z"></path></svg>About</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/bucketlist/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"></path><path d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8zm0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zM4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zm0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"></path></svg>Bucket List</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/recipes/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M151.7 16.73s-20.6 14.12-22 25.18c-1.4 11.33 17.6 19.24 15.6 30.48-1.3 7.43-16.6 15.38-16.6 15.38s38.7-3.36 42.3-18.3c2.9-11.82-19.8-16.61-23-28.35-2.1-7.94 3.7-24.39 3.7-24.39zm214.4 4.89s-24.8 13.58-24.9 25.45c-.1 7.24 14.4 8.67 14.8 15.9.5 8.56-15.3 20.68-15.3 20.68s33.6-3.81 38.1-16.97c2.7-7.77-9.4-13.81-11.6-21.73-2.1-7.5-1.1-23.33-1.1-23.33zm-106.9.26s-26.9 13.75-24.9 25.45c1.4 7.93 20.6 2.62 21.7 10.6 1.7 13.01-29.6 25.98-29.6 25.98s56.5-1.44 58.8-22.27c1.1-9.88-20-7.79-24.9-16.43-3.9-6.77-1.1-23.33-1.1-23.33zM48 105.6v18h416v-18zm16 37c-14.48 86.9 16.9 138.1 58.6 168.2-3.6-24.8-14.1-49.1-35.06-72.2 39.96 10.5 71.36 48.8 85.36 87.2 2.3-18.8 2.3-27.5 19.5-44.2-3.1 24.8 11.2 26.5 21.2 23.4 25.3-7.9 35.6-39.5 10.6-78.9 47.6 22.7 48.3 48.4 56.3 83.7-2.4-33.2 24.3-46.5 43.7-34-45.1 22.7-8.2 42.2 6.9 47 40 12.8 70-46.3 87.2-91 4.7 19.8.8 39.7-6.5 59.5C441.4 260 459.7 213 448 142.6zm184.3 175.2L75 417.5c2.7 18.4 9 34.4 18.8 48.5l92-44.1-78.7 59.9c3.4 3.4 7.1 6.6 11 9.7l74.7-42.9c0-.7-.1-1.5-.1-2.2 0-37.2 30.5-67.6 67.8-67.6 10.6 0 20.6 2.4 29.5 6.7-2.4-13.4-7.3-27.1-14.8-39.2l-94.9 40.1 82.5-56.5c-4.4-4.5-9.2-8.6-14.5-12.1zm58.9 57.6c1.6 7.2 2.6 14.4 3 21.4l.2 3.9c11.1 12 17.9 28.1 17.9 45.7 0 7.8-1.3 15.3-3.8 22.2l91.4 24.4c4.6-6.3 8.6-12.8 11.8-19.4l-63.1-24.7 70.1 6.9c.9-3 1.6-5.9 2.2-8.9l-97.1-34.3 99.2 15.5c.2-5.8-.1-11.7-.8-17.7zm-46.7 22.1c-27.2 0-49.1 21.8-49.1 48.9 0 27.1 21.9 48.9 49.1 48.9 27.3 0 49.2-21.8 49.2-48.9 0-27.1-21.9-48.9-49.2-48.9zm-4.9 11.8c43.8 0 58.4 71.6 0 71.6 26.6-23.1 29.8-46.9 0-71.6zm.2 9.8c-21.6 17.9-19.3 35.2 0 52-42.4 0-31.8-52 0-52z"></path></svg>Cooking</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/flying/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M487 37.1C396.4 53.23 292 95.28 207.5 140 163 163.6 124 187.8 95.39 209.2 81.08 220 69.36 230 60.93 238.6c-8.43 8.7-13.38 16.3-14.65 20.3-9.04 28.7-3.42 57.7 1.73 84.7 9.55 50.4-3.23 88.9-22.98 126.3 25.24-5.7 45.36-19.8 57-47 8.47-19.8 9.13-37 11.43-57.6 2.3-20.6 6.45-44.2 22.44-73.2l.2-.4.2-.4c8.8-12.6 26.2-22.2 50-33.4 23.7-11.2 53.6-23 86-35.1 63.8-23.8 137.2-48.7 190.1-71.3 20-30.1 34-74.24 44.6-114.4zm-55 138.2c-51.7 21-116.6 43.1-173.5 64.3-32.2 12-61.8 23.7-84.6 34.5-22.6 10.7-38.5 21.6-42.6 27.2-6.8 12.3-11.1 23.2-14 33.3 83.4-6.5 195.3-31.8 271.3-66.6 27.4-29.7 36.9-59.7 43.4-92.7zm-58 118.8c-79 32.2-182 53.3-260.8 58.6-.9 5-1.5 9.8-2 14.6-.4 3.5-.7 7.1-1.1 10.6 72.4 7.5 136.3 4 206.2-6.5 32.6-22.5 49.8-49.6 57.7-77.3zm-78.4 98.2c-62.3 8.1-121.6 10.2-187.6 3.4-.7 4.5-1.6 9-2.7 13.6 35.9 19.2 98.1 25.8 140.7 24.6 30.2-12.4 41.5-24.8 49.6-41.6zM99.78 426.7c-1.15 2.1-3.14 6.7-4.21 8.9 14.03 20.2 48.73 32.2 88.43 39.3 21.2-8 28.3-15.5 36.5-23-39.7-1.1-86.7-7.7-120.7-25.2z"></path></svg>Flying</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li></ul></div><div class="w-full flex flex-col" id="main-content"><div class="self-center mt-7 max-w-2xl w-[80%]"><article class=""><div class="__className_12746b mb-9"><h2 class="__className_df02b7 text-2xl">High Availability WordPress LAMP Stack – Part 2</h2><div class="text-xs text-gray-400 italic mb-5">Created: <span>4/13/2012, 8:16:30 AM</span></div><div class="prose lg:prose-lg"><p>This article is the second in a series (<a href="http://www.scottyob.com/2012/04/13/ha-network/">see part 1 here</a>).  Please see <a href="http://www.scottyob.com/2012/04/13/ha-network/">HA Network</a> for the first part in setting up the network topology to be highly available.</p>
<p>It’s all good having a redundant network design, but putting web servers and the like on our hypervisors doesn’t make them redundant.  In the event where there’s a failure on one of our servers, all virtual machines on that server will die.  Looking at our previous network design, we can see a failure on a web server or database server would cause service outage.</p>
<!-- -->
<img src="/posts/2012/ha-system-software/Old-Network-1-3ZGHFJMC.jpg" alt="Old Netowrk"/>
<p>In this example, I’m going to talk about a few pretty cool pieces of software that you can use to make a highly available (HA) service stack for hosting Apache web sites from a MySQL data store.  This post isn’t going to be about all the in’s and out’s of how to accomplish, but hopefully it will answer some questions you might have when setting out to accomplish this task as well as point you to the appropriate articles to help you achieve what you’re after.</p>
<h4>Nginx load balancing proxy</h4>
<p>Lets look first at an example of a previous example.  Lets take a simple network where we have a web server with a client.  The A record for www.example.com points to our web server at 192.168.0.10 (of course we’d use NAT on the firewalls in my example to expose it to the internet).</p>
<img src="/posts/2012/ha-system-software/skitched-3-E3RBXFRX.jpg" alt="Old Example"/>
<p>From my previous post, we can tell that the network topology to reach our web server on 192.168.0.10 is highly redundant, if the server itself, or the physical machine it’s hosted on in the case of virtual machines does die, we can no longer serve web pages.</p>
<p>To solve this problem, we’re going to create multiple web servers. The A record for www.example.com is now no longer going to be pointing to the web server itself, but a proxy server (I recommend <a href="http://wiki.nginx.org/Configuration">Nginx</a>.) Now you can see that if either web server dies, our proxy server is able to start handing out requests through the other server. This method is also recommended because it mitigates load from a single server. If your web site got more popular, we can just start scaling out and adding more web servers into the mix to handle the load. Now, I know what you’re thinking, and yes, we have just moved the single point of failure from the web server to the proxy server, but please read on to find out how to protect that host from failure.</p>
<img src="/posts/2012/ha-system-software/Proxy-Server-1-DCDCC7VE.jpg" alt="Proxy server"/>
<h4>Heartbeat, keep your servers beating</h4>
<p>In the previous example, we had a server that was a single point of failure.  If the proxy server in this case died, then our web site would go down.  To plan against the failure of this machine, you can set up a tool such as <a href="http://www.howtoforge.com/high_availability_heartbeat_centos">Heartbeat</a>.  An example works like the following, your proxy server above is running the Nginx daemon handling your client’s requests, but it does so using a virtual network adaptor where it’s IP address 192.168.0.10 sits.  You put a second server in here in the mix with the same Nginx daemon and the same configuration, but it’s not running or serving anything, this is known as our slave server.  The slave server is sending heartbeat messages to the master server.  In the event that the master server stops responding to the slave’s heartbeat messages, it assumes the master is down and will create a virtual adaptor assuming the working IP address (192.168.0.10 in our example) and brings up the master services.</p>
<img src="/posts/2012/ha-system-software/Heartbeat-1-RWQCQV7H.jpg" alt="Heartbeat"/>
<p>I use heartbeat extensively through my HA configurations. Not only for allowing services to be taken up by a slave in the event of a master failure, but also where I have clusters (for example, a MySQL cluster). When the slave assumes the master’s IP address, it’s handy to write a little script/service here to stop any replication and assume the master’s role.</p>
<p><strong>ProTip:</strong> Managing configuration across your servers when you start creating multiple instances for redundancy can start to get out of hand very quickly. Sometimes you can change a configuration on one server and forget to do it on another. I suggest using a tool like <a href="http://en.wikipedia.org/wiki/Puppet_(software)">Puppet</a> to manage the configuration on your servers for you</p>
<p><strong>ProTip:</strong> From experience, I’ve had situations in failover testing where the failure of a core switch will cause heartbeat to stop receiving heartbeats and fail the servers over, even though the physical and virtual machines themselves are fine. If you’re running the (non-rapid) Spanning Tree Protocol (STP) on your network, I suggest making the timeout for Heartbeat about 45 seconds. This should be enough time to allow for STP convergence before it assumes it’s partner is dead.</p>
<h4>NFS File Store</h4>
<p>In the example above, we’ve got multiple web servers. As I’ve said, this setup could be used to host a HA WordPress site. The problem is that when content that sits on the file system (such as an image or theme uploaded, wordpress upgrade, etc) takes place, it will no longer be in sync with the other web servers. For us, hosting the wordpress installation from an NFS mount point worked fine, which begins a thought on how to make this NFS server highly available.</p>
<p>Just like the previous example, we’re going to use Heartbeat to make sure we’ve got a master and slave, and that when the master fails, the slave will start hosting the NFS services. There’s only one more added piece of complexity here. If the master fails, the slave has none of the data that was stored on the master. To get around this, I’m using a tool called DRBD. DRBD allows a block device to be created and synced across multiple hosts. When you write to this device, data is replicated on the slave too. That way when the master dies and the slave takes it’s roll, it will have all the data that existed previously on the master. A good tutorial to set this up can be found <a href="http://www.howtoforge.com/high_availability_nfs_drbd_heartbeat">HERE</a></p>
<p><strong>ProTip:</strong> Once again from experience, when everything is not working as expected, having the slave be promoted is a horrible thing. If the data has not been replicating for some reason over the past few months and the slave gets promoted with data that’s a few months old, it can be a horrible, horrible thing. I suggest running a tool like Nagios on your stack to monitor EVERYTHING you can think of. A good way to check if your DRBD servers are in sync is to look for the term UpToDate/UpToDate in /proc/drbd.</p>
<h4>MySQL Cluster</h4>
<p>There are two ways of running your MySQL server in high redundancy. One simple method using tools you’ve already used is to have the MySQL data store running over DRBD and have Heartbeat keeping it in track. This is pretty simple to set up and I’m running it on one of my sites without a problem.</p>
<p>The problem with running MySQL in this sort of setup is scale. Putting your web servers behind a load balancing proxy is a good first step in allowing for you to slot more servers in your solution and starting to scale out. Once the bottleneck moves to your MySQL server, running a single active/passive pair over DRBD won’t scale out, only up (more expensive, faster hardware).</p>
<p>The second time I had to set this up, I chose to run my servers in a <a href="http://dev.mysql.com/doc/refman/5.1/en/replication.html">MySQL cluster</a>. This means that whenever a transaction is committed on the master, it is sent to the slave to commit as well. The advantage with this is that it allows you to spread out SELECT queries among your slaves instead of running everything on your one server.</p>
<h4>Word for the wise</h4>
<p>Now we have a highly available network stack in place with highly available system services, we can sleep better knowing that if a system outage were to occur, we have our insurance policy in place knowing that in about 50 seconds, a network issue can converge and services can be automatically moved over to hot standby machines. This does not however give you an excuse to not have a backup strategy in place.</p>
<p>If you’re doing backups as an afterthought, I can recommend setting up an OpenIndiana machine running ZFS on it. Setting it up <a href="http://www.scottyob.com/category/nerd/fileserver-nerd/">like I have</a> off site with rotating snapshots. At our work we do nightly backups and for us it’s as simple as doing a database dump, then rsync’ing everything over to this remote ZFS machine to get snapshotted, feeling safe I can access old data from 6 weeks ago (my nightly snapshot period.)</p>
<h4>What’s to come?</h4>
<p>If you’ve got this far, Thanks for reading and I hope this post pointed you in the right direction to help build highly available services. I think more and more in today’s world people are expecting IT infrastructure to be always up and available. If you don’t have standby servers available, sooner or later, you’re bound to have unhappy customers. I’ve always wanted to build a disaster recovery site, with a highly active database so that in the event of an entire site failing over (think natural disaster, people errors and the like) a site can fail over to another physical disaster recovery (DR) location.</p></div></div></article></div></div></div><script src="/_next/static/chunks/webpack-c0d6ce99d471eac9.js" async=""></script><script src="/_next/static/chunks/fd9d1056-f562485b1666a0a3.js" async=""></script><script src="/_next/static/chunks/596-5b64dbf019a905f5.js" async=""></script><script src="/_next/static/chunks/main-app-c71b577ad5f96a17.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/70a6988bfc142772.css\",{\"as\":\"style\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/media/42e58f5a516ebb1b-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n5:HL[\"/_next/static/media/d45575ed0ad4f563-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n6:HL[\"/_next/static/css/d699b3284dd0f0c8.css\",{\"as\":\"style\"}]\n7:HL[\"/_next/static/media/8679c800f1e60000-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n8:HL[\"/_next/static/media/af1939b13935fec8-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n9:HL["])</script><script>self.__next_f.push([1,"\"/_next/static/css/e1665b43251c86eb.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"a:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-c0d6ce99d471eac9.js\",\"971:static/chunks/fd9d1056-f562485b1666a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"default\",\"async\":false}\nc:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-c0d6ce99d471eac9.js\",\"971:static/chunks/fd9d1056-f562485b1666a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"GlobalError\",\"async\":false}\nd:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-c0d6ce99d471eac9.js\",\"971:static/chunks/fd9d1056-f562485b1666"])</script><script>self.__next_f.push([1,"a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"default\",\"async\":false}\ne:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpack-c0d6ce99d471eac9.js\",\"971:static/chunks/fd9d1056-f562485b1666a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"default\",\"async\":false}\nf:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-a0750907e0c935bc.js\",\"222:static/chunks/222-0c303d3189115893.js\",\"982:static/chunks/982-07d375c9d37b134d.js\",\"46:static/chunks/app/(navbar)/(margined)/page-4623163d6cd3c237.js\"],\"na"])</script><script>self.__next_f.push([1,"me\":\"\",\"async\":false}\n10:I{\"id\":2179,\"chunks\":[\"724:static/chunks/358ff52d-5af8921f222f7c20.js\",\"122:static/chunks/e416a3ff-be1b889799c50168.js\",\"447:static/chunks/00cbbcb7-5522c112e5f40d45.js\",\"685:static/chunks/685-a0750907e0c935bc.js\",\"713:static/chunks/app/(navbar)/layout-53648850bb136a0a.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/70a6988bfc142772.css\",\"precedence\":\"next\"}]],[\"$\",\"$La\",null,{\"buildId\":\"aQlZSs9CDQ5o1878iGuKG\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/2012/ha-system-software/\",\"initialTree\":[\"\",{\"children\":[\"(navbar)\",{\"children\":[\"(margined)\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"2012/ha-system-software\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"2012\\\",\\\"ha-system-software\\\"]}\",{}]}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":\"$Lb\",\"globalErrorComponent\":\"$c\",\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"body\",null,{\"className\":\"__className_e66fe9\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_31da3a\",\"children\":[\"$\",\"$Lf\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$L10\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"div\",null,{\"className\":\"self-center mt-7 max-w-2xl w-[80%]\",\"children\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\",\"(margined)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\",\"(margined)\",\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\",\"(margined)\",\"children\",\"post\",\"children\",[\"slug\",\"2012/ha-system-software\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L11\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"2012\\\",\\\"ha-system-software\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/e1665b43251c86eb.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"2012/ha-system-software\",\"c\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}]}],null],\"segment\":\"(margined)\"},\"styles\":[]}]}]]}]}],null],\"segment\":\"(navbar)\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/d699b3284dd0f0c8.css\",\"precedence\":\"next\"}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Scott O'Brien\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"My online creative outlet\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\n"])</script><script>self.__next_f.push([1,"12:I{\"id\":8248,\"chunks\":[\"222:static/chunks/222-0c303d3189115893.js\",\"982:static/chunks/982-07d375c9d37b134d.js\",\"344:static/chunks/app/(navbar)/(margined)/post/[...slug]/page-a0f72aa7860b7ab0.js\"],\"name\":\"\",\"async\":false}\n13:I{\"id\":9098,\"chunks\":[\"222:static/chunks/222-0c303d3189115893.js\",\"982:static/chunks/982-07d375c9d37b134d.js\",\"344:static/chunks/app/(navbar)/(margined)/post/[...slug]/page-a0f72aa7860b7ab0.js\"],\"name\":\"\",\"async\":false}\n14:T2ff7,"])</script><script>self.__next_f.push([1,"var Component=(()=\u003e{var m=Object.create;var a=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var x=(o,e)=\u003e()=\u003e(e||o((e={exports:{}}).exports,e),e.exports),k=(o,e)=\u003e{for(var r in e)a(o,r,{get:e[r],enumerable:!0})},n=(o,e,r,i)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let E of g(e))!w.call(o,E)\u0026\u0026E!==r\u0026\u0026a(o,E,{get:()=\u003ee[E],enumerable:!(i=P(e,E))||i.enumerable});return o};var C=(o,e,r)=\u003e(r=o!=null?m(p(o)):{},n(e||!o||!o.__esModule?a(r,\"default\",{value:o,enumerable:!0}):r,o)),v=o=\u003en(a({},\"__esModule\",{value:!0}),o);var Q=x(($,s)=\u003e{s.exports=_jsx_runtime});var b={};k(b,{default:()=\u003eD,frontmatter:()=\u003eO});var t=C(Q());var h=\"/posts/2012/ha-system-software/Old-Network-1-3ZGHFJMC.jpg\";var l=\"/posts/2012/ha-system-software/skitched-3-E3RBXFRX.jpg\";var c=\"/posts/2012/ha-system-software/Proxy-Server-1-DCDCC7VE.jpg\";var u=\"/posts/2012/ha-system-software/Heartbeat-1-RWQCQV7H.jpg\";var O={title:\"High Availability WordPress LAMP Stack \\u2013 Part 2\",author:\"scottyob\",type:\"post\",date:new Date(133430499e4),url:\"/2012/04/13/ha-software/\",categories:[\"nerd\"],tags:[\"HA\",\"Heartbeat\",\"MySQL\",\"NFS\",\"Nginx\"],hero:\"Heartbeat-1.jpg\",hideHero:!0};function d(o){let e=Object.assign({p:\"p\",a:\"a\",h4:\"h4\",strong:\"strong\"},o.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(e.p,{children:[\"This article is the second in a series (\",(0,t.jsx)(e.a,{href:\"http://www.scottyob.com/2012/04/13/ha-network/\",children:\"see part 1 here\"}),\"). \\xA0Please see \",(0,t.jsx)(e.a,{href:\"http://www.scottyob.com/2012/04/13/ha-network/\",children:\"HA Network\"}),\"\\xA0for the first part in setting up the network topology to be highly\\xA0available.\"]}),`\n`,(0,t.jsx)(e.p,{children:\"It\\u2019s all good having a redundant network design, but putting web servers and the like on our hypervisors doesn\\u2019t make them redundant. \\xA0In the event where there\\u2019s a failure on one of our servers, all virtual machines on that server will die. \\xA0Looking at our previous network design, we can see a failure on a web server or database server would cause service outage.\"}),`\n`,`\n`,(0,t.jsx)(\"img\",{src:h,alt:\"Old Netowrk\"}),`\n`,(0,t.jsx)(e.p,{children:\"In this example, I\\u2019m going to talk about a few pretty cool pieces of software that you can use to make a highly available (HA) service stack for hosting Apache web sites from a MySQL data store. \\xA0This post isn\\u2019t going to be about all the in\\u2019s and out\\u2019s of how to accomplish, but hopefully it will answer some questions you might have when setting out to accomplish this task as well as point you to the appropriate articles to help you achieve what you\\u2019re after.\"}),`\n`,(0,t.jsx)(e.h4,{children:\"Nginx load balancing proxy\"}),`\n`,(0,t.jsx)(e.p,{children:\"Lets look first at an example of a previous example. \\xA0Lets take a simple network where we have a web server with a client. \\xA0The A record for www.example.com points to our web server at 192.168.0.10 (of course we\\u2019d use NAT on the firewalls in my example to expose it to the internet).\"}),`\n`,(0,t.jsx)(\"img\",{src:l,alt:\"Old Example\"}),`\n`,(0,t.jsx)(e.p,{children:\"From my previous post, we can tell that the network topology to reach our web server on 192.168.0.10 is highly redundant, if the server itself, or the physical machine it\\u2019s hosted on in the case of virtual machines does die, we can no longer serve web pages.\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"To solve this problem, we\\u2019re going to create multiple web servers. The A record for www.example.com is now no longer going to be pointing to the web server itself, but a proxy server (I recommend \",(0,t.jsx)(e.a,{href:\"http://wiki.nginx.org/Configuration\",children:\"Nginx\"}),\".) Now you can see that if either web server dies, our proxy server is able to start handing out requests through the other server. This method is also recommended because it mitigates load from a single server. If your web site got more popular, we can just start scaling out and adding more web servers into the mix to handle the load. Now, I know what you\\u2019re thinking, and yes, we have just moved the single point of failure from the web server to the proxy server, but please read on to find out how to protect that host from failure.\"]}),`\n`,(0,t.jsx)(\"img\",{src:c,alt:\"Proxy server\"}),`\n`,(0,t.jsx)(e.h4,{children:\"Heartbeat, keep your servers beating\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"In the previous example, we had a server that was a single point of failure. \\xA0If the proxy server in this case died, then our web site would go down. \\xA0To plan against the failure of this machine, you can set up a tool such as \",(0,t.jsx)(e.a,{href:\"http://www.howtoforge.com/high_availability_heartbeat_centos\",children:\"Heartbeat\"}),\". \\xA0An example works like the following, your proxy server above is running the Nginx daemon handling your client\\u2019s requests, but it does so using a virtual network adaptor where it\\u2019s IP address 192.168.0.10 sits. \\xA0You put a second server in here in the mix with the same Nginx daemon and the same configuration, but it\\u2019s not running or serving anything, this is known as our slave server. \\xA0The slave server is sending heartbeat messages to the master server. \\xA0In the event that the master server stops responding to the slave\\u2019s heartbeat messages, it assumes the master is down and will create a virtual adaptor assuming the working IP address (192.168.0.10 in our example) and brings up the master services.\"]}),`\n`,(0,t.jsx)(\"img\",{src:u,alt:\"Heartbeat\"}),`\n`,(0,t.jsx)(e.p,{children:\"I use heartbeat extensively through my HA configurations. Not only for allowing services to be taken up by a slave in the event of a master failure, but also where I have clusters (for example, a MySQL cluster). When the slave assumes the master\\u2019s IP address, it\\u2019s handy to write a little script/service here to stop any replication and assume the master\\u2019s role.\"}),`\n`,(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:\"ProTip:\"}),\" Managing configuration across your servers when you start creating multiple instances for redundancy can start to get out of hand very quickly. Sometimes you can change a configuration on one server and forget to do it on another. I suggest using a tool like \",(0,t.jsx)(e.a,{href:\"http://en.wikipedia.org/wiki/Puppet_(software)\",children:\"Puppet\"}),\" to manage the configuration on your servers for you\"]}),`\n`,(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:\"ProTip:\"}),\" From experience, I\\u2019ve had situations in failover testing where the failure of a core switch will cause heartbeat to stop receiving heartbeats and fail the servers over, even though the physical and virtual machines themselves are fine. If you\\u2019re running the (non-rapid) Spanning Tree Protocol (STP) on your network, I suggest making the timeout for Heartbeat about 45 seconds. This should be enough time to allow for STP convergence before it assumes it\\u2019s partner is dead.\"]}),`\n`,(0,t.jsx)(e.h4,{children:\"NFS File Store\"}),`\n`,(0,t.jsx)(e.p,{children:\"In the example above, we\\u2019ve got multiple web servers. As I\\u2019ve said, this setup could be used to host a HA WordPress site. The problem is that when content that sits on the file system (such as an image or theme uploaded, wordpress upgrade, etc) takes place, it will no longer be in sync with the other web servers. For us, hosting the wordpress installation from an NFS mount point worked fine, which begins a thought on how to make this NFS server highly available.\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"Just like the previous example, we\\u2019re going to use Heartbeat to make sure we\\u2019ve got a master and slave, and that when the master fails, the slave will start hosting the NFS services. There\\u2019s only one more added piece of complexity here. If the master fails, the slave has none of the data that was stored on the master. To get around this, I\\u2019m using a tool called DRBD. DRBD allows a block device to be created and synced across multiple hosts. When you write to this device, data is replicated on the slave too. That way when the master dies and the slave takes it\\u2019s roll, it will have all the data that existed previously on the master. A good tutorial to set this up can be found \",(0,t.jsx)(e.a,{href:\"http://www.howtoforge.com/high_availability_nfs_drbd_heartbeat\",children:\"HERE\"})]}),`\n`,(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:\"ProTip:\"}),\" Once again from experience, when everything is not working as expected, having the slave be promoted is a horrible thing. If the data has not been replicating for some reason over the past few months and the slave gets promoted with data that\\u2019s a few months old, it can be a horrible, horrible thing. I suggest running a tool like Nagios on your stack to monitor EVERYTHING you can think of. A good way to check if your DRBD servers are in sync is to look for the term UpToDate/UpToDate in /proc/drbd.\"]}),`\n`,(0,t.jsx)(e.h4,{children:\"MySQL Cluster\"}),`\n`,(0,t.jsx)(e.p,{children:\"There are two ways of running your MySQL server in high redundancy. One simple method using tools you\\u2019ve already used is to have the MySQL data store running over DRBD and have Heartbeat keeping it in track. This is pretty simple to set up and I\\u2019m running it on one of my sites without a problem.\"}),`\n`,(0,t.jsx)(e.p,{children:\"The problem with running MySQL in this sort of setup is scale. Putting your web servers behind a load balancing proxy is a good first step in allowing for you to slot more servers in your solution and starting to scale out. Once the bottleneck moves to your MySQL server, running a single active/passive pair over DRBD won\\u2019t scale out, only up (more expensive, faster hardware).\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"The second time I had to set this up, I chose to run my servers in a \",(0,t.jsx)(e.a,{href:\"http://dev.mysql.com/doc/refman/5.1/en/replication.html\",children:\"MySQL cluster\"}),\". This means that whenever a transaction is committed on the master, it is sent to the slave to commit as well. The advantage with this is that it allows you to spread out SELECT queries among your slaves instead of running everything on your one server.\"]}),`\n`,(0,t.jsx)(e.h4,{children:\"Word for the wise\"}),`\n`,(0,t.jsx)(e.p,{children:\"Now we have a highly available network stack in place with highly available system services, we can sleep better knowing that if a system outage were to occur, we have our insurance policy in place knowing that in about 50 seconds, a network issue can converge and services can be automatically moved over to hot standby machines. This does not however give you an excuse to not have a backup strategy in place.\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"If you\\u2019re doing backups as an afterthought, I can recommend setting up an OpenIndiana machine running ZFS on it. Setting it up \",(0,t.jsx)(e.a,{href:\"http://www.scottyob.com/category/nerd/fileserver-nerd/\",children:\"like I have\"}),\" off site with rotating snapshots. At our work we do nightly backups and for us it\\u2019s as simple as doing a database dump, then rsync\\u2019ing everything over to this remote ZFS machine to get snapshotted, feeling safe I can access old data from 6 weeks ago (my nightly snapshot period.)\"]}),`\n`,(0,t.jsx)(e.h4,{children:\"What\\u2019s to come?\"}),`\n`,(0,t.jsx)(e.p,{children:\"If you\\u2019ve got this far, Thanks for reading and I hope this post pointed you in the right direction to help build highly available services. I think more and more in today\\u2019s world people are expecting IT infrastructure to be always up and available. If you don\\u2019t have standby servers available, sooner or later, you\\u2019re bound to have unhappy customers. I\\u2019ve always wanted to build a disaster recovery site, with a highly active database so that in the event of an entire site failing over (think natural disaster, people errors and the like) a site can fail over to another physical disaster recovery (DR) location.\"})]})}function F(o={}){let{wrapper:e}=o.components||{};return e?(0,t.jsx)(e,Object.assign({},o,{children:(0,t.jsx)(d,o)})):d(o)}var D=F;return v(b);})();\n;return Component;"])</script><script>self.__next_f.push([1,"11:[\"$\",\"article\",null,{\"className\":\"\",\"children\":[\"$\",\"div\",null,{\"className\":\"__className_12746b mb-9\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"__className_df02b7 text-2xl\",\"children\":\"High Availability WordPress LAMP Stack – Part 2\"}],[\"$\",\"div\",null,{\"className\":\"text-xs text-gray-400 italic mb-5\",\"children\":[\"Created: \",[\"$\",\"$L12\",null,{\"date\":\"$D2012-04-13T08:16:30.000Z\"}]]}],\"$undefined\",[\"$\",\"div\",null,{\"className\":\"prose lg:prose-lg\",\"children\":[\"$\",\"$L13\",null,{\"code\":\"$14\"}]}]]}]}]\n"])</script></body></html>