1:HL["/_next/static/css/8a1e8ec2da824aa2.css",{"as":"style"}]
0:["qM5d7cw-vDbPGZohIedvu",[[["",{"children":["(navbar)",{"children":["(margined)",{"children":["post",{"children":[["slug","2011/fileserver-2-snapshots","c"],{"children":["__PAGE__?{\"slug\":[\"2011\",\"fileserver-2-snapshots\"]}",{}]}]}]}]}]},"$undefined","$undefined",true],"$L2",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/8a1e8ec2da824aa2.css","precedence":"next"}]],"$L3"]]]]
4:HL["/_next/static/media/2aaf0723e720e8b9-s.p.woff2",{"as":"font","type":"font/woff2"}]
5:HL["/_next/static/media/42e58f5a516ebb1b-s.p.woff2",{"as":"font","type":"font/woff2"}]
6:HL["/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2",{"as":"font","type":"font/woff2"}]
7:HL["/_next/static/css/c2c1ea965511607d.css",{"as":"style"}]
8:HL["/_next/static/media/8679c800f1e60000-s.p.woff2",{"as":"font","type":"font/woff2"}]
9:HL["/_next/static/media/af1939b13935fec8-s.p.woff2",{"as":"font","type":"font/woff2"}]
a:HL["/_next/static/css/e1665b43251c86eb.css",{"as":"style"}]
b:I{"id":7767,"chunks":["272:static/chunks/webpack-6a94f4f450a79057.js","971:static/chunks/fd9d1056-f562485b1666a0a3.js","596:static/chunks/596-5b64dbf019a905f5.js"],"name":"default","async":false}
c:I{"id":7920,"chunks":["272:static/chunks/webpack-6a94f4f450a79057.js","971:static/chunks/fd9d1056-f562485b1666a0a3.js","596:static/chunks/596-5b64dbf019a905f5.js"],"name":"default","async":false}
d:I{"id":6685,"chunks":["685:static/chunks/685-a0750907e0c935bc.js","222:static/chunks/222-0c303d3189115893.js","982:static/chunks/982-07d375c9d37b134d.js","46:static/chunks/app/(navbar)/(margined)/page-6e97965ff90afede.js"],"name":"","async":false}
e:I{"id":2179,"chunks":["724:static/chunks/358ff52d-5af8921f222f7c20.js","122:static/chunks/e416a3ff-be1b889799c50168.js","447:static/chunks/00cbbcb7-5522c112e5f40d45.js","685:static/chunks/685-a0750907e0c935bc.js","713:static/chunks/app/(navbar)/layout-e1a28f5172e21563.js"],"name":"","async":false}
2:[["$","html",null,{"lang":"en","children":["$","$Lb",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$Lc",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":[["$","body",null,{"className":"__className_20951f","children":["$","div",null,{"className":"flex max-w-full w-full flex-col pt-8 pb-8","children":[["$","div",null,{"className":"self-center w-full","children":[["$","h1",null,{"className":"text-center text-4xl __className_31da3a","children":["$","$Ld",null,{"href":"/","children":"Scott O'Brien"}]}],["$","$Le",null,{}]]}],["$","div",null,{"className":"w-full flex flex-col","id":"main-content","children":["$","$Lb",null,{"parallelRouterKey":"children","segmentPath":["children","(navbar)","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$Lc",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":[["$","div",null,{"className":"self-center mt-7 max-w-2xl w-[80%]","children":["$","$Lb",null,{"parallelRouterKey":"children","segmentPath":["children","(navbar)","children","(margined)","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$Lc",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$Lb",null,{"parallelRouterKey":"children","segmentPath":["children","(navbar)","children","(margined)","children","post","children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$Lc",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$Lb",null,{"parallelRouterKey":"children","segmentPath":["children","(navbar)","children","(margined)","children","post","children",["slug","2011/fileserver-2-snapshots","c"],"children"],"error":"$undefined","errorStyles":"$undefined","loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"template":["$","$Lc",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$Lf",null],"segment":"__PAGE__?{\"slug\":[\"2011\",\"fileserver-2-snapshots\"]}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/e1665b43251c86eb.css","precedence":"next"}]]}],"segment":["slug","2011/fileserver-2-snapshots","c"]},"styles":[]}],"segment":"post"},"styles":[]}]}],null],"segment":"(margined)"},"styles":[]}]}]]}]}],null],"segment":"(navbar)"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/c2c1ea965511607d.css","precedence":"next"}]]}]}],null]
3:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Scott O'Brien"}],["$","meta","2",{"name":"description","content":"My online creative outlet"}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"any"}],["$","meta","5",{"name":"next-size-adjust"}]]
10:I{"id":8248,"chunks":["222:static/chunks/222-0c303d3189115893.js","982:static/chunks/982-07d375c9d37b134d.js","344:static/chunks/app/(navbar)/(margined)/post/[...slug]/page-dd011dba93e6ca3b.js"],"name":"","async":false}
11:I{"id":9098,"chunks":["222:static/chunks/222-0c303d3189115893.js","982:static/chunks/982-07d375c9d37b134d.js","344:static/chunks/app/(navbar)/(margined)/post/[...slug]/page-dd011dba93e6ca3b.js"],"name":"","async":false}
12:T1bb3,var Component=(()=>{var d=Object.create;var o=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var g=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),y=(n,e)=>{for(var s in e)o(n,s,{get:e[s],enumerable:!0})},i=(n,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of u(e))!f.call(n,a)&&a!==s&&o(n,a,{get:()=>e[a],enumerable:!(r=p(e,a))||r.enumerable});return n};var b=(n,e,s)=>(s=n!=null?d(m(n)):{},i(e||!n||!n.__esModule?o(s,"default",{value:n,enumerable:!0}):s,n)),w=n=>i(o({},"__esModule",{value:!0}),n);var h=g(($,l)=>{l.exports=_jsx_runtime});var x={};y(x,{default:()=>v,frontmatter:()=>k});var t=b(h()),k={title:"Filesystem Snapshots",author:"scottyob",type:"post",date:new Date(1300450236e3),url:"/2011/03/18/3-setting-up-filesystems-and-snapshots/",categories:["FileServer"],tags:["fileserver","ZFS"]};function c(n){let e=Object.assign({p:"p",em:"em",pre:"pre",code:"code",a:"a",h3:"h3",ol:"ol",li:"li"},n.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.p,{children:(0,t.jsx)(e.em,{children:"Note: This post is one in a series aimed to be a tutorial eventually, it\u2019s not currently finalised and at the moment exists as a place for collating thought and collecting feedback"})}),`
`,(0,t.jsx)(e.p,{children:"Setting up the FileSystems is a trivial task.\xA0 First, you can see that when we\u2019ve created a storage pool \u2018datastore\u2019 it created a filesystem for us (also called datastore) that can act as a container for child file systems.\xA0 I\u2019m going to go ahead and create a place to store my media and downloads now"}),`
`,`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/media
`})}),`
`,(0,t.jsx)(e.p,{children:"for now I\u2019ll also want a place to store my backups.\xA0 It\u2019s worth noting that while my media filesystem will contain compressed MP3\u2019s and the like, it\u2019s kind of a waste of CPU power to compress it, but my backups will be a lot of PHP pages and what not, so lets go ahead and enable compression on this one"}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/backups
`})}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs set compression=on datastore/backups
`})}),`
`,(0,t.jsx)(e.p,{children:"As appalled as I am of my mums backup habits, one of the requirements of this server was to provide a medium for backing up her data without her having to do anything, so lets set up backup locations for my laptop (MacShell) and a place for mum (mum) assigning both of these 20GB quota\u2019s (ok, MacShell gets 120GB)"}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/backups/MacShell
# zfs create datastore/backups/mum
# zfs set quota=120G datastore/backups/MacShell
# zfs set quota=20GB datastore/backups/mum
# zfs get datastore/backups/mum
`})}),`
`,(0,t.jsxs)(e.p,{children:["Now, the idea is that a cron job will run rsyncing over the files every hour, on the hour.\xA0 For many reasons (in case I get a virus and need to revert back, in case somebody hacks in and does bad stuff, etc, etc) I\u2019m going to choose to ",(0,t.jsx)(e.a,{href:"http://docs.huihoo.com/opensolaris/solaris-zfs-administration-guide/html/ch06.html",children:"create Snapshots"})," so I can roll back to a previous version."]}),`
`,(0,t.jsx)(e.p,{children:"The convention I want is hourly.HOUR, daily.DAY, weekly.WEEK for up to 7 days and 4 weeks.\xA0 This also means that once I delete a file, I won\u2019t recover the space that it took (once a snapshot of the file has been created) in my data pool until the end of the 4 week period.\xA0 for instance, hourly.0 will be the last hours snapshot, hourly.1 will be the 2nd last hours snapshot, etc."}),`
`,(0,t.jsxs)(e.p,{children:["the following bash script will take care of the desired snapshots.\xA0 It\u2019s based on a concept I took from this ",(0,t.jsx)(e.a,{href:"http://blogs.sun.com/mmusante/entry/rolling_snapshots_made_easy",children:"rolling snapshots made easy"})," post but I like ",(0,t.jsx)(e.a,{href:"/img/old/2011/03/snapshot.sh",children:"my scripted way of doing rotating snapshots"})," much better."]}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:`#!/bin/bash

#print out usage
if [ $# -ne 2 ]
then
  echo "Usage: snapshot.sh [snapName] [max]"
  echo "  eg. snapshot.sh hour 24"
fi

#if the max snapshot already exists, just delete it
if [ $(zfs list -t snapshot | grep datastore@$1.$2 | wc -l) -eq 1 ]
then
  zfs destroy -r datastore@$1.$2
fi

for ((i=$2-1; i >= 0; i--)); do
  if [ $(zfs list -t snapshot | grep datastore@$1.$i | wc -l) -eq 1 ]
  then
    #this snapshot exists, so we want to move it up one
    zfs rename -r datastore@$1.$i @$1.$[$i+1]
  fi
done

zfs snapshot -r datastore@$1.0
`})}),`
`,(0,t.jsx)(e.p,{children:"so with this snapshot beauty in place, lets say I had an existing file and structure in place"}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`root@thumper:/datastore/backups/MacShell# pwd
/datastore/backups/MacShell
root@thumper:/datastore/backups/MacShell# tree
.
|\u2013 hello_world.txt
|\u2013 someDir
|- someFile.dat

1 directory, 2 files
`})}),`
`,(0,t.jsx)(e.p,{children:"BUT, I had a snapshot in place"}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# /snapshot.sh hourly 24
`})}),`
`,(0,t.jsx)(e.p,{children:"then I did something silly like delete my entire backup directory (Oh No!!)"}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# rm -R *
# ls -l

total 0
`})}),`
`,(0,t.jsx)(e.p,{children:"never fear! check the snapshots"}),`
`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`root@thumper:/datastore/backups/
MacShell/.zfs/snapshot/hourly.0# tree
|\u2013 hello_world.txt
 \u2013 someDir
\`\u2013 someFile.dat
`})}),`
`,(0,t.jsx)(e.p,{children:"they\u2019ll eventually roll off my snapshot cycle and be removed in 4 weeks with my plan, but hey, pretty good at this point \u{1F642}"}),`
`,(0,t.jsxs)(e.p,{children:["See ",(0,t.jsx)(e.a,{href:"http://www.scottyob.com/?p=96",children:"Part 2"})," for a post on how to set up cron jobs to automatically call this script"]}),`
`,(0,t.jsx)(e.h3,{children:"other posts to come in the series:"}),`
`,(0,t.jsxs)(e.ol,{children:[`
`,(0,t.jsx)(e.li,{children:"Selecting the hardware"}),`
`,(0,t.jsx)(e.li,{children:"Installing the Operating System"}),`
`,(0,t.jsx)(e.li,{children:"Setting up File systems & Snapshots"}),`
`,(0,t.jsx)(e.li,{children:"Allowing access through NFS & SAMBA"}),`
`,(0,t.jsx)(e.li,{children:"Setting up encrypted off-site backups"}),`
`,(0,t.jsx)(e.li,{children:"Configuring Windows & Linux clients to dump backup info to the FileServer"}),`
`,(0,t.jsx)(e.li,{children:"My router setup, configuring IP tables & torrents on a low-powered server."}),`
`]})]})}function S(n={}){let{wrapper:e}=n.components||{};return e?(0,t.jsx)(e,Object.assign({},n,{children:(0,t.jsx)(c,n)})):c(n)}var v=S;return w(x);})();
;return Component;f:["$","article",null,{"className":"","children":["$","div",null,{"className":"__className_12746b mb-9","children":[["$","h2",null,{"className":"__className_df02b7 text-2xl","children":"Filesystem Snapshots"}],["$","div",null,{"className":"text-xs text-gray-400 italic mb-5","children":["Created: ",["$","$L10",null,{"date":"$D2011-03-18T12:10:36.000Z"}]]}],"$undefined",["$","div",null,{"className":"prose lg:prose-lg","children":["$","$L11",null,{"code":"$12"}]}]]}]}]
