<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/2aaf0723e720e8b9-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/42e58f5a516ebb1b-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/8679c800f1e60000-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/d2c70a2e5d6bd385-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/0d26c7c4f71e78d1.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/386fa29998ac6a74.css" data-precedence="next"/><title>Scott O&#x27;Brien</title><meta name="description" content="My online creative outlet"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_0ec1f4"><div class="flex max-w-full w-full flex-col pt-8 pb-8"><div class="self-center w-full"><h1 class="text-center text-4xl __className_baad2a"><a href="/">Scott O&#x27;Brien</a></h1><ul class="flex flex-wrap justify-center space-x-2 text-gray-400 italic pt-3 mb-8 max-w-2xl w-[80%] m-auto __className_6cf34a"><li class="transition group duration-300 whitespace-nowrap"><a href="/">Writings/Projects</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-[70%] bg-orange-500"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/about/">About</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/bucketlist/">Bucket List</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/recipes/">Cooking</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/flying/">Flying</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li></ul></div><div class="w-full flex flex-col" id="main-content"><div class="self-center mt-7 max-w-2xl w-[80%]"><article class=""><div class="__className_af3318 mb-9"><h2 class="__className_59b087 text-2xl">Filesystem Snapshots</h2><div class="text-xs text-gray-400 italic mb-5">Created: <span>3/18/2011, 12:10:36 PM</span></div><div class="prose lg:prose-lg"><p><em>Note: This post is one in a series aimed to be a tutorial eventually, itâ€™s not currently finalised and at the moment exists as a place for collating thought and collecting feedback</em></p>
<p>Setting up the FileSystems is a trivial task.Â  First, you can see that when weâ€™ve created a storage pool â€˜datastoreâ€™ it created a filesystem for us (also called datastore) that can act as a container for child file systems.Â  Iâ€™m going to go ahead and create a place to store my media and downloads now</p>
<!-- -->
<pre><code># zfs create datastore/media
</code></pre>
<p>for now Iâ€™ll also want a place to store my backups.Â  Itâ€™s worth noting that while my media filesystem will contain compressed MP3â€™s and the like, itâ€™s kind of a waste of CPU power to compress it, but my backups will be a lot of PHP pages and what not, so lets go ahead and enable compression on this one</p>
<pre><code># zfs create datastore/backups
</code></pre>
<pre><code># zfs set compression=on datastore/backups
</code></pre>
<p>As appalled as I am of my mums backup habits, one of the requirements of this server was to provide a medium for backing up her data without her having to do anything, so lets set up backup locations for my laptop (MacShell) and a place for mum (mum) assigning both of these 20GB quotaâ€™s (ok, MacShell gets 120GB)</p>
<pre><code># zfs create datastore/backups/MacShell
# zfs create datastore/backups/mum
# zfs set quota=120G datastore/backups/MacShell
# zfs set quota=20GB datastore/backups/mum
# zfs get datastore/backups/mum
</code></pre>
<p>Now, the idea is that a cron job will run rsyncing over the files every hour, on the hour.Â  For many reasons (in case I get a virus and need to revert back, in case somebody hacks in and does bad stuff, etc, etc) Iâ€™m going to choose to <a href="http://docs.huihoo.com/opensolaris/solaris-zfs-administration-guide/html/ch06.html">create Snapshots</a> so I can roll back to a previous version.</p>
<p>The convention I want is hourly.HOUR, daily.DAY, weekly.WEEK for up to 7 days and 4 weeks.Â  This also means that once I delete a file, I wonâ€™t recover the space that it took (once a snapshot of the file has been created) in my data pool until the end of the 4 week period.Â  for instance, hourly.0 will be the last hours snapshot, hourly.1 will be the 2nd last hours snapshot, etc.</p>
<p>the following bash script will take care of the desired snapshots.Â  Itâ€™s based on a concept I took from this <a href="http://blogs.sun.com/mmusante/entry/rolling_snapshots_made_easy">rolling snapshots made easy</a> post but I like <a href="/img/old/2011/03/snapshot.sh">my scripted way of doing rotating snapshots</a> much better.</p>
<pre><code class="language-bash">#!/bin/bash

#print out usage
if [ $# -ne 2 ]
then
  echo &quot;Usage: snapshot.sh [snapName] [max]&quot;
  echo &quot;  eg. snapshot.sh hour 24&quot;
fi

#if the max snapshot already exists, just delete it
if [ $(zfs list -t snapshot | grep datastore@$1.$2 | wc -l) -eq 1 ]
then
  zfs destroy -r datastore@$1.$2
fi

for ((i=$2-1; i &gt;= 0; i--)); do
  if [ $(zfs list -t snapshot | grep datastore@$1.$i | wc -l) -eq 1 ]
  then
    #this snapshot exists, so we want to move it up one
    zfs rename -r datastore@$1.$i @$1.$[$i+1]
  fi
done

zfs snapshot -r datastore@$1.0
</code></pre>
<p>so with this snapshot beauty in place, lets say I had an existing file and structure in place</p>
<pre><code>root@thumper:/datastore/backups/MacShell# pwd
/datastore/backups/MacShell
root@thumper:/datastore/backups/MacShell# tree
.
|â€“ hello_world.txt
|â€“ someDir
|- someFile.dat

1 directory, 2 files
</code></pre>
<p>BUT, I had a snapshot in place</p>
<pre><code># /snapshot.sh hourly 24
</code></pre>
<p>then I did something silly like delete my entire backup directory (Oh No!!)</p>
<pre><code># rm -R *
# ls -l

total 0
</code></pre>
<p>never fear! check the snapshots</p>
<pre><code>root@thumper:/datastore/backups/
MacShell/.zfs/snapshot/hourly.0# tree
|â€“ hello_world.txt
 â€“ someDir
`â€“ someFile.dat
</code></pre>
<p>theyâ€™ll eventually roll off my snapshot cycle and be removed in 4 weeks with my plan, but hey, pretty good at this point ðŸ™‚</p>
<p>See <a href="http://www.scottyob.com/?p=96">Part 2</a> for a post on how to set up cron jobs to automatically call this script</p>
<h3>other posts to come in the series:</h3>
<ol>
<li>Selecting the hardware</li>
<li>Installing the Operating System</li>
<li>Setting up File systems &amp; Snapshots</li>
<li>Allowing access through NFS &amp; SAMBA</li>
<li>Setting up encrypted off-site backups</li>
<li>Configuring Windows &amp; Linux clients to dump backup info to the FileServer</li>
<li>My router setup, configuring IP tables &amp; torrents on a low-powered server.</li>
</ol></div></div></article></div></div></div><script src="/_next/static/chunks/webpack-6854f8b189d0947c.js" async=""></script><script src="/_next/static/chunks/bce60fc1-e7cb3874f5f47943.js" async=""></script><script src="/_next/static/chunks/769-64fef319af2abb40.js" async=""></script><script src="/_next/static/chunks/main-app-7c73dbeff8b74fd8.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/2aaf0723e720e8b9-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/42e58f5a516ebb1b-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/css/0d26c7c4f71e78d1.css\",{\"as\":\"style\"}]\n0:\"$L5\"\n"])</script><script>self.__next_f.push([1,"6:HL[\"/_next/static/media/8679c800f1e60000-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n7:HL[\"/_next/static/media/d2c70a2e5d6bd385-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n8:HL[\"/_next/static/css/386fa29998ac6a74.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"9:I{\"id\":\"8802\",\"chunks\":[\"272:static/chunks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\nb:I{\"id\":\"4299\",\"chunks\":[\"272:static/chunks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\nc:I{\"id\":\"7477\",\"chunks\":[\"477:static/chunks/477-6554af05b281746c.js\",\"153:static/chunks/153-7f7061897db69601.js\",\"651:static/"])</script><script>self.__next_f.push([1,"chunks/651-05a1ce4efc0860d4.js\",\"534:static/chunks/app/flying/location/[slug]/page-65be048863d8522d.js\"],\"name\":\"\",\"async\":false}\nd:I{\"id\":\"5212\",\"chunks\":[\"477:static/chunks/477-6554af05b281746c.js\",\"185:static/chunks/app/layout-9d8f06291be9ea84.js\"],\"name\":\"\",\"async\":false}\nf:I{\"id\":\"3211\",\"chunks\":[\"272:static/chunks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\n10:I{\"id\":\"5767\",\"chunks\":[\"272:static/chu"])</script><script>self.__next_f.push([1,"nks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0d26c7c4f71e78d1.css\",\"precedence\":\"next\"}]],[\"$\",\"$L9\",null,{\"buildId\":\"7bnD85EgJ3cUdh6-mHFZs\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/2011/fileserver-2-snapshots/\",\"initialTree\":[\"\",{\"children\":[\"(margined)\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"2011/fileserver-2-snapshots\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"2011\\\",\\\"fileserver-2-snapshots\\\"]}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$La\",[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]],\"globalErrorComponent\":\"$b\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_0ec1f4\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_baad2a\",\"children\":[\"$\",\"$Lc\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$Ld\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$Le\",\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}]]}]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_0ec1f4\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_baad2a\",\"children\":[\"$\",\"$Lc\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$Ld\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"div\",null,{\"className\":\"self-center mt-7 max-w-2xl w-[80%]\",\"children\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\",\"post\",\"children\",[\"slug\",\"2011/fileserver-2-snapshots\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L11\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"2011\\\",\\\"fileserver-2-snapshots\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/386fa29998ac6a74.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"2011/fileserver-2-snapshots\",\"c\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}]}],null],\"segment\":\"(margined)\"},\"styles\":[]}]}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Scott O'Brien\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"My online creative outlet\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]]\n"])</script><script>self.__next_f.push([1,"12:I{\"id\":\"9114\",\"chunks\":[\"962:static/chunks/962-226f429e9782fad0.js\",\"726:static/chunks/app/(margined)/post/[...slug]/page-063ddffa9c53bc9d.js\"],\"name\":\"\",\"async\":false}\n13:I{\"id\":\"5470\",\"chunks\":[\"91:static/chunks/app/flying/flight/[slug]/page-5440ec33784e9466.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"11:[\"$\",\"article\",null,{\"className\":\"\",\"children\":[\"$\",\"div\",null,{\"className\":\"__className_af3318 mb-9\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"__className_59b087 text-2xl\",\"children\":\"Filesystem Snapshots\"}],[\"$\",\"div\",null,{\"className\":\"text-xs text-gray-400 italic mb-5\",\"children\":[\"Created: \",[\"$\",\"$L12\",null,{\"date\":\"$D2011-03-18T12:10:36.000Z\"}]]}],\"$undefined\",[\"$\",\"div\",null,{\"className\":\"prose lg:prose-lg\",\"children\":[\"$\",\"$L13\",null,{\"code\":\"var Component=(()=\u003e{var d=Object.create;var o=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var g=(n,e)=\u003e()=\u003e(e||n((e={exports:{}}).exports,e),e.exports),y=(n,e)=\u003e{for(var s in e)o(n,s,{get:e[s],enumerable:!0})},i=(n,e,s,r)=\u003e{if(e\u0026\u0026typeof e==\\\"object\\\"||typeof e==\\\"function\\\")for(let a of u(e))!f.call(n,a)\u0026\u0026a!==s\u0026\u0026o(n,a,{get:()=\u003ee[a],enumerable:!(r=p(e,a))||r.enumerable});return n};var b=(n,e,s)=\u003e(s=n!=null?d(m(n)):{},i(e||!n||!n.__esModule?o(s,\\\"default\\\",{value:n,enumerable:!0}):s,n)),w=n=\u003ei(o({},\\\"__esModule\\\",{value:!0}),n);var h=g(($,l)=\u003e{l.exports=_jsx_runtime});var x={};y(x,{default:()=\u003ev,frontmatter:()=\u003ek});var t=b(h()),k={title:\\\"Filesystem Snapshots\\\",author:\\\"scottyob\\\",type:\\\"post\\\",date:new Date(1300450236e3),url:\\\"/2011/03/18/3-setting-up-filesystems-and-snapshots/\\\",categories:[\\\"FileServer\\\"],tags:[\\\"fileserver\\\",\\\"ZFS\\\"]};function c(n){let e=Object.assign({p:\\\"p\\\",em:\\\"em\\\",pre:\\\"pre\\\",code:\\\"code\\\",a:\\\"a\\\",h3:\\\"h3\\\",ol:\\\"ol\\\",li:\\\"li\\\"},n.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.p,{children:(0,t.jsx)(e.em,{children:\\\"Note: This post is one in a series aimed to be a tutorial eventually, it\\\\u2019s not currently finalised and at the moment exists as a place for collating thought and collecting feedback\\\"})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"Setting up the FileSystems is a trivial task.\\\\xA0 First, you can see that when we\\\\u2019ve created a storage pool \\\\u2018datastore\\\\u2019 it created a filesystem for us (also called datastore) that can act as a container for child file systems.\\\\xA0 I\\\\u2019m going to go ahead and create a place to store my media and downloads now\\\"}),`\\n`,`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/media\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"for now I\\\\u2019ll also want a place to store my backups.\\\\xA0 It\\\\u2019s worth noting that while my media filesystem will contain compressed MP3\\\\u2019s and the like, it\\\\u2019s kind of a waste of CPU power to compress it, but my backups will be a lot of PHP pages and what not, so lets go ahead and enable compression on this one\\\"}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/backups\\n`})}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs set compression=on datastore/backups\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"As appalled as I am of my mums backup habits, one of the requirements of this server was to provide a medium for backing up her data without her having to do anything, so lets set up backup locations for my laptop (MacShell) and a place for mum (mum) assigning both of these 20GB quota\\\\u2019s (ok, MacShell gets 120GB)\\\"}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/backups/MacShell\\n# zfs create datastore/backups/mum\\n# zfs set quota=120G datastore/backups/MacShell\\n# zfs set quota=20GB datastore/backups/mum\\n# zfs get datastore/backups/mum\\n`})}),`\\n`,(0,t.jsxs)(e.p,{children:[\\\"Now, the idea is that a cron job will run rsyncing over the files every hour, on the hour.\\\\xA0 For many reasons (in case I get a virus and need to revert back, in case somebody hacks in and does bad stuff, etc, etc) I\\\\u2019m going to choose to \\\",(0,t.jsx)(e.a,{href:\\\"http://docs.huihoo.com/opensolaris/solaris-zfs-administration-guide/html/ch06.html\\\",children:\\\"create Snapshots\\\"}),\\\" so I can roll back to a previous version.\\\"]}),`\\n`,(0,t.jsx)(e.p,{children:\\\"The convention I want is hourly.HOUR, daily.DAY, weekly.WEEK for up to 7 days and 4 weeks.\\\\xA0 This also means that once I delete a file, I won\\\\u2019t recover the space that it took (once a snapshot of the file has been created) in my data pool until the end of the 4 week period.\\\\xA0 for instance, hourly.0 will be the last hours snapshot, hourly.1 will be the 2nd last hours snapshot, etc.\\\"}),`\\n`,(0,t.jsxs)(e.p,{children:[\\\"the following bash script will take care of the desired snapshots.\\\\xA0 It\\\\u2019s based on a concept I took from this \\\",(0,t.jsx)(e.a,{href:\\\"http://blogs.sun.com/mmusante/entry/rolling_snapshots_made_easy\\\",children:\\\"rolling snapshots made easy\\\"}),\\\" post but I like \\\",(0,t.jsx)(e.a,{href:\\\"/img/old/2011/03/snapshot.sh\\\",children:\\\"my scripted way of doing rotating snapshots\\\"}),\\\" much better.\\\"]}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:\\\"language-bash\\\",children:`#!/bin/bash\\n\\n#print out usage\\nif [ $# -ne 2 ]\\nthen\\n  echo \\\"Usage: snapshot.sh [snapName] [max]\\\"\\n  echo \\\"  eg. snapshot.sh hour 24\\\"\\nfi\\n\\n#if the max snapshot already exists, just delete it\\nif [ $(zfs list -t snapshot | grep datastore@$1.$2 | wc -l) -eq 1 ]\\nthen\\n  zfs destroy -r datastore@$1.$2\\nfi\\n\\nfor ((i=$2-1; i \u003e= 0; i--)); do\\n  if [ $(zfs list -t snapshot | grep datastore@$1.$i | wc -l) -eq 1 ]\\n  then\\n    #this snapshot exists, so we want to move it up one\\n    zfs rename -r datastore@$1.$i @$1.$[$i+1]\\n  fi\\ndone\\n\\nzfs snapshot -r datastore@$1.0\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"so with this snapshot beauty in place, lets say I had an existing file and structure in place\\\"}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`root@thumper:/datastore/backups/MacShell# pwd\\n/datastore/backups/MacShell\\nroot@thumper:/datastore/backups/MacShell# tree\\n.\\n|\\\\u2013 hello_world.txt\\n|\\\\u2013 someDir\\n|- someFile.dat\\n\\n1 directory, 2 files\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"BUT, I had a snapshot in place\\\"}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# /snapshot.sh hourly 24\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"then I did something silly like delete my entire backup directory (Oh No!!)\\\"}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# rm -R *\\n# ls -l\\n\\ntotal 0\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"never fear! check the snapshots\\\"}),`\\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`root@thumper:/datastore/backups/\\nMacShell/.zfs/snapshot/hourly.0# tree\\n|\\\\u2013 hello_world.txt\\n \\\\u2013 someDir\\n\\\\`\\\\u2013 someFile.dat\\n`})}),`\\n`,(0,t.jsx)(e.p,{children:\\\"they\\\\u2019ll eventually roll off my snapshot cycle and be removed in 4 weeks with my plan, but hey, pretty good at this point \\\\u{1F642}\\\"}),`\\n`,(0,t.jsxs)(e.p,{children:[\\\"See \\\",(0,t.jsx)(e.a,{href:\\\"http://www.scottyob.com/?p=96\\\",children:\\\"Part 2\\\"}),\\\" for a post on how to set up cron jobs to automatically call this script\\\"]}),`\\n`,(0,t.jsx)(e.h3,{children:\\\"other posts to come in the series:\\\"}),`\\n`,(0,t.jsxs)(e.ol,{children:[`\\n`,(0,t.jsx)(e.li,{children:\\\"Selecting the hardware\\\"}),`\\n`,(0,t.jsx)(e.li,{children:\\\"Installing the Operating System\\\"}),`\\n`,(0,t.jsx)(e.li,{children:\\\"Setting up File systems \u0026 Snapshots\\\"}),`\\n`,(0,t.jsx)(e.li,{children:\\\"Allowing access through NFS \u0026 SAMBA\\\"}),`\\n`,(0,t.jsx)(e.li,{children:\\\"Setting up encrypted off-site backups\\\"}),`\\n`,(0,t.jsx)(e.li,{children:\\\"Configuring Windows \u0026 Linux clients to dump backup info to the FileServer\\\"}),`\\n`,(0,t.jsx)(e.li,{children:\\\"My router setup, configuring IP tables \u0026 torrents on a low-powered server.\\\"}),`\\n`]})]})}function S(n={}){let{wrapper:e}=n.components||{};return e?(0,t.jsx)(e,Object.assign({},n,{children:(0,t.jsx)(c,n)})):c(n)}var v=S;return w(x);})();\\n;return Component;\"}]}]]}]}]\n"])</script></body></html>