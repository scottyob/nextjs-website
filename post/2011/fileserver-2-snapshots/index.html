<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/42e58f5a516ebb1b-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/d45575ed0ad4f563-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/8679c800f1e60000-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/af1939b13935fec8-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/f8d4b94408297a98.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/d699b3284dd0f0c8.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/e1665b43251c86eb.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-512ccd8bf4443ca0.js" as="script"/><link rel="preload" href="/_next/static/chunks/fd9d1056-f562485b1666a0a3.js" as="script"/><link rel="preload" href="/_next/static/chunks/596-5b64dbf019a905f5.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-app-c71b577ad5f96a17.js" as="script"/><title>Scott O&#x27;Brien</title><meta name="description" content="My online creative outlet"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_e66fe9"><div class="flex max-w-full w-full flex-col pt-8 pb-8"><div class="self-center w-full"><h1 class="text-center text-4xl __className_31da3a"><a href="/">Scott O&#x27;Brien</a></h1><ul class="flex flex-wrap justify-center text-gray-400 italic pt-3 mb-8 max-w-2xl w-[80%] m-auto [&amp;&gt;li]:ml-3 [&amp;&gt;li]:mr-3 [&amp;_svg]:inline [&amp;_svg]:mr-1 __className_7febbd"><li class="transition group duration-300 whitespace-nowrap"><a href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" version="1.1" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 10l2-1 7-7-1-1-7 7-1 2zM4.52 13.548c-0.494-1.043-1.026-1.574-2.069-2.069l1.548-4.262 2-1.217 6-6h-3l-6 6-3 10 10-3 6-6v-3l-6 6-1.217 2z"></path></svg>Writings/Projects</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-[85%] bg-orange-500"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/about/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" version="1.1" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9 1.5c0 0.828-0.672 1.5-1.5 1.5s-1.5-0.672-1.5-1.5c0-0.828 0.672-1.5 1.5-1.5s1.5 0.672 1.5 1.5z"></path><path d="M9 4h-3c-0.552 0-1 0.448-1 1v5h1v6h1.25v-6h0.5v6h1.25v-6h1v-5c0-0.552-0.448-1-1-1z"></path></svg>About</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/bucketlist/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"></path><path d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8zm0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zM4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zm0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"></path></svg>Bucket List</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/recipes/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M151.7 16.73s-20.6 14.12-22 25.18c-1.4 11.33 17.6 19.24 15.6 30.48-1.3 7.43-16.6 15.38-16.6 15.38s38.7-3.36 42.3-18.3c2.9-11.82-19.8-16.61-23-28.35-2.1-7.94 3.7-24.39 3.7-24.39zm214.4 4.89s-24.8 13.58-24.9 25.45c-.1 7.24 14.4 8.67 14.8 15.9.5 8.56-15.3 20.68-15.3 20.68s33.6-3.81 38.1-16.97c2.7-7.77-9.4-13.81-11.6-21.73-2.1-7.5-1.1-23.33-1.1-23.33zm-106.9.26s-26.9 13.75-24.9 25.45c1.4 7.93 20.6 2.62 21.7 10.6 1.7 13.01-29.6 25.98-29.6 25.98s56.5-1.44 58.8-22.27c1.1-9.88-20-7.79-24.9-16.43-3.9-6.77-1.1-23.33-1.1-23.33zM48 105.6v18h416v-18zm16 37c-14.48 86.9 16.9 138.1 58.6 168.2-3.6-24.8-14.1-49.1-35.06-72.2 39.96 10.5 71.36 48.8 85.36 87.2 2.3-18.8 2.3-27.5 19.5-44.2-3.1 24.8 11.2 26.5 21.2 23.4 25.3-7.9 35.6-39.5 10.6-78.9 47.6 22.7 48.3 48.4 56.3 83.7-2.4-33.2 24.3-46.5 43.7-34-45.1 22.7-8.2 42.2 6.9 47 40 12.8 70-46.3 87.2-91 4.7 19.8.8 39.7-6.5 59.5C441.4 260 459.7 213 448 142.6zm184.3 175.2L75 417.5c2.7 18.4 9 34.4 18.8 48.5l92-44.1-78.7 59.9c3.4 3.4 7.1 6.6 11 9.7l74.7-42.9c0-.7-.1-1.5-.1-2.2 0-37.2 30.5-67.6 67.8-67.6 10.6 0 20.6 2.4 29.5 6.7-2.4-13.4-7.3-27.1-14.8-39.2l-94.9 40.1 82.5-56.5c-4.4-4.5-9.2-8.6-14.5-12.1zm58.9 57.6c1.6 7.2 2.6 14.4 3 21.4l.2 3.9c11.1 12 17.9 28.1 17.9 45.7 0 7.8-1.3 15.3-3.8 22.2l91.4 24.4c4.6-6.3 8.6-12.8 11.8-19.4l-63.1-24.7 70.1 6.9c.9-3 1.6-5.9 2.2-8.9l-97.1-34.3 99.2 15.5c.2-5.8-.1-11.7-.8-17.7zm-46.7 22.1c-27.2 0-49.1 21.8-49.1 48.9 0 27.1 21.9 48.9 49.1 48.9 27.3 0 49.2-21.8 49.2-48.9 0-27.1-21.9-48.9-49.2-48.9zm-4.9 11.8c43.8 0 58.4 71.6 0 71.6 26.6-23.1 29.8-46.9 0-71.6zm.2 9.8c-21.6 17.9-19.3 35.2 0 52-42.4 0-31.8-52 0-52z"></path></svg>Cooking</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/flying/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M487 37.1C396.4 53.23 292 95.28 207.5 140 163 163.6 124 187.8 95.39 209.2 81.08 220 69.36 230 60.93 238.6c-8.43 8.7-13.38 16.3-14.65 20.3-9.04 28.7-3.42 57.7 1.73 84.7 9.55 50.4-3.23 88.9-22.98 126.3 25.24-5.7 45.36-19.8 57-47 8.47-19.8 9.13-37 11.43-57.6 2.3-20.6 6.45-44.2 22.44-73.2l.2-.4.2-.4c8.8-12.6 26.2-22.2 50-33.4 23.7-11.2 53.6-23 86-35.1 63.8-23.8 137.2-48.7 190.1-71.3 20-30.1 34-74.24 44.6-114.4zm-55 138.2c-51.7 21-116.6 43.1-173.5 64.3-32.2 12-61.8 23.7-84.6 34.5-22.6 10.7-38.5 21.6-42.6 27.2-6.8 12.3-11.1 23.2-14 33.3 83.4-6.5 195.3-31.8 271.3-66.6 27.4-29.7 36.9-59.7 43.4-92.7zm-58 118.8c-79 32.2-182 53.3-260.8 58.6-.9 5-1.5 9.8-2 14.6-.4 3.5-.7 7.1-1.1 10.6 72.4 7.5 136.3 4 206.2-6.5 32.6-22.5 49.8-49.6 57.7-77.3zm-78.4 98.2c-62.3 8.1-121.6 10.2-187.6 3.4-.7 4.5-1.6 9-2.7 13.6 35.9 19.2 98.1 25.8 140.7 24.6 30.2-12.4 41.5-24.8 49.6-41.6zM99.78 426.7c-1.15 2.1-3.14 6.7-4.21 8.9 14.03 20.2 48.73 32.2 88.43 39.3 21.2-8 28.3-15.5 36.5-23-39.7-1.1-86.7-7.7-120.7-25.2z"></path></svg>Flying</a><span class="block group-hover:max-w-[75%] m-auto transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li></ul></div><div class="w-full flex flex-col" id="main-content"><div class="self-center mt-7 max-w-2xl w-[80%]"><article class=""><div class="__className_12746b mb-9"><h2 class="__className_df02b7 text-2xl">Filesystem Snapshots</h2><div class="text-xs text-gray-400 italic mb-5">Created: <span>3/18/2011, 12:10:36 PM</span></div><div class="prose lg:prose-lg"><p><em>Note: This post is one in a series aimed to be a tutorial eventually, itâ€™s not currently finalised and at the moment exists as a place for collating thought and collecting feedback</em></p>
<p>Setting up the FileSystems is a trivial task.Â  First, you can see that when weâ€™ve created a storage pool â€˜datastoreâ€™ it created a filesystem for us (also called datastore) that can act as a container for child file systems.Â  Iâ€™m going to go ahead and create a place to store my media and downloads now</p>
<!-- -->
<pre><code># zfs create datastore/media
</code></pre>
<p>for now Iâ€™ll also want a place to store my backups.Â  Itâ€™s worth noting that while my media filesystem will contain compressed MP3â€™s and the like, itâ€™s kind of a waste of CPU power to compress it, but my backups will be a lot of PHP pages and what not, so lets go ahead and enable compression on this one</p>
<pre><code># zfs create datastore/backups
</code></pre>
<pre><code># zfs set compression=on datastore/backups
</code></pre>
<p>As appalled as I am of my mums backup habits, one of the requirements of this server was to provide a medium for backing up her data without her having to do anything, so lets set up backup locations for my laptop (MacShell) and a place for mum (mum) assigning both of these 20GB quotaâ€™s (ok, MacShell gets 120GB)</p>
<pre><code># zfs create datastore/backups/MacShell
# zfs create datastore/backups/mum
# zfs set quota=120G datastore/backups/MacShell
# zfs set quota=20GB datastore/backups/mum
# zfs get datastore/backups/mum
</code></pre>
<p>Now, the idea is that a cron job will run rsyncing over the files every hour, on the hour.Â  For many reasons (in case I get a virus and need to revert back, in case somebody hacks in and does bad stuff, etc, etc) Iâ€™m going to choose to <a href="http://docs.huihoo.com/opensolaris/solaris-zfs-administration-guide/html/ch06.html">create Snapshots</a> so I can roll back to a previous version.</p>
<p>The convention I want is hourly.HOUR, daily.DAY, weekly.WEEK for up to 7 days and 4 weeks.Â  This also means that once I delete a file, I wonâ€™t recover the space that it took (once a snapshot of the file has been created) in my data pool until the end of the 4 week period.Â  for instance, hourly.0 will be the last hours snapshot, hourly.1 will be the 2nd last hours snapshot, etc.</p>
<p>the following bash script will take care of the desired snapshots.Â  Itâ€™s based on a concept I took from this <a href="http://blogs.sun.com/mmusante/entry/rolling_snapshots_made_easy">rolling snapshots made easy</a> post but I like <a href="/img/old/2011/03/snapshot.sh">my scripted way of doing rotating snapshots</a> much better.</p>
<pre><code class="language-bash">#!/bin/bash

#print out usage
if [ $# -ne 2 ]
then
  echo &quot;Usage: snapshot.sh [snapName] [max]&quot;
  echo &quot;  eg. snapshot.sh hour 24&quot;
fi

#if the max snapshot already exists, just delete it
if [ $(zfs list -t snapshot | grep datastore@$1.$2 | wc -l) -eq 1 ]
then
  zfs destroy -r datastore@$1.$2
fi

for ((i=$2-1; i &gt;= 0; i--)); do
  if [ $(zfs list -t snapshot | grep datastore@$1.$i | wc -l) -eq 1 ]
  then
    #this snapshot exists, so we want to move it up one
    zfs rename -r datastore@$1.$i @$1.$[$i+1]
  fi
done

zfs snapshot -r datastore@$1.0
</code></pre>
<p>so with this snapshot beauty in place, lets say I had an existing file and structure in place</p>
<pre><code>root@thumper:/datastore/backups/MacShell# pwd
/datastore/backups/MacShell
root@thumper:/datastore/backups/MacShell# tree
.
|â€“ hello_world.txt
|â€“ someDir
|- someFile.dat

1 directory, 2 files
</code></pre>
<p>BUT, I had a snapshot in place</p>
<pre><code># /snapshot.sh hourly 24
</code></pre>
<p>then I did something silly like delete my entire backup directory (Oh No!!)</p>
<pre><code># rm -R *
# ls -l

total 0
</code></pre>
<p>never fear! check the snapshots</p>
<pre><code>root@thumper:/datastore/backups/
MacShell/.zfs/snapshot/hourly.0# tree
|â€“ hello_world.txt
 â€“ someDir
`â€“ someFile.dat
</code></pre>
<p>theyâ€™ll eventually roll off my snapshot cycle and be removed in 4 weeks with my plan, but hey, pretty good at this point ðŸ™‚</p>
<p>See <a href="http://www.scottyob.com/?p=96">Part 2</a> for a post on how to set up cron jobs to automatically call this script</p>
<h3>other posts to come in the series:</h3>
<ol>
<li>Selecting the hardware</li>
<li>Installing the Operating System</li>
<li>Setting up File systems &amp; Snapshots</li>
<li>Allowing access through NFS &amp; SAMBA</li>
<li>Setting up encrypted off-site backups</li>
<li>Configuring Windows &amp; Linux clients to dump backup info to the FileServer</li>
<li>My router setup, configuring IP tables &amp; torrents on a low-powered server.</li>
</ol></div></div></article></div></div></div><script src="/_next/static/chunks/webpack-512ccd8bf4443ca0.js" async=""></script><script src="/_next/static/chunks/fd9d1056-f562485b1666a0a3.js" async=""></script><script src="/_next/static/chunks/596-5b64dbf019a905f5.js" async=""></script><script src="/_next/static/chunks/main-app-c71b577ad5f96a17.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/f8d4b94408297a98.css\",{\"as\":\"style\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/media/42e58f5a516ebb1b-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n5:HL[\"/_next/static/media/d45575ed0ad4f563-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n6:HL[\"/_next/static/css/d699b3284dd0f0c8.css\",{\"as\":\"style\"}]\n7:HL[\"/_next/static/media/8679c800f1e60000-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n8:HL[\"/_next/static/media/af1939b13935fec8-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n9:HL["])</script><script>self.__next_f.push([1,"\"/_next/static/css/e1665b43251c86eb.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"a:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-512ccd8bf4443ca0.js\",\"971:static/chunks/fd9d1056-f562485b1666a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"default\",\"async\":false}\nc:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-512ccd8bf4443ca0.js\",\"971:static/chunks/fd9d1056-f562485b1666a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"GlobalError\",\"async\":false}\nd:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-512ccd8bf4443ca0.js\",\"971:static/chunks/fd9d1056-f562485b1666"])</script><script>self.__next_f.push([1,"a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"default\",\"async\":false}\ne:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpack-512ccd8bf4443ca0.js\",\"971:static/chunks/fd9d1056-f562485b1666a0a3.js\",\"596:static/chunks/596-5b64dbf019a905f5.js\"],\"name\":\"default\",\"async\":false}\nf:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-bd04e00715de5b93.js\",\"222:static/chunks/222-0319df8e2b26098e.js\",\"982:static/chunks/982-07d375c9d37b134d.js\",\"46:static/chunks/app/(navbar)/(margined)/page-63b1cc75eae7afd0.js\"],\"na"])</script><script>self.__next_f.push([1,"me\":\"\",\"async\":false}\n10:I{\"id\":2179,\"chunks\":[\"724:static/chunks/358ff52d-5af8921f222f7c20.js\",\"122:static/chunks/e416a3ff-be1b889799c50168.js\",\"447:static/chunks/00cbbcb7-5522c112e5f40d45.js\",\"685:static/chunks/685-bd04e00715de5b93.js\",\"713:static/chunks/app/(navbar)/layout-53648850bb136a0a.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f8d4b94408297a98.css\",\"precedence\":\"next\"}]],[\"$\",\"$La\",null,{\"buildId\":\"wLMJTS-A44KWX0Rgd8SXl\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/2011/fileserver-2-snapshots/\",\"initialTree\":[\"\",{\"children\":[\"(navbar)\",{\"children\":[\"(margined)\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"2011/fileserver-2-snapshots\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"2011\\\",\\\"fileserver-2-snapshots\\\"]}\",{}]}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":\"$Lb\",\"globalErrorComponent\":\"$c\",\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"body\",null,{\"className\":\"__className_e66fe9\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_31da3a\",\"children\":[\"$\",\"$Lf\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$L10\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"div\",null,{\"className\":\"self-center mt-7 max-w-2xl w-[80%]\",\"children\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\",\"(margined)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\",\"(margined)\",\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Ld\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(navbar)\",\"children\",\"(margined)\",\"children\",\"post\",\"children\",[\"slug\",\"2011/fileserver-2-snapshots\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Le\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L11\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"2011\\\",\\\"fileserver-2-snapshots\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/e1665b43251c86eb.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"2011/fileserver-2-snapshots\",\"c\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}]}],null],\"segment\":\"(margined)\"},\"styles\":[]}]}]]}]}],null],\"segment\":\"(navbar)\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/d699b3284dd0f0c8.css\",\"precedence\":\"next\"}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Scott O'Brien\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"My online creative outlet\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\n"])</script><script>self.__next_f.push([1,"12:I{\"id\":8248,\"chunks\":[\"222:static/chunks/222-0319df8e2b26098e.js\",\"982:static/chunks/982-07d375c9d37b134d.js\",\"344:static/chunks/app/(navbar)/(margined)/post/[...slug]/page-e4edb86238a82fde.js\"],\"name\":\"\",\"async\":false}\n13:I{\"id\":9098,\"chunks\":[\"222:static/chunks/222-0319df8e2b26098e.js\",\"982:static/chunks/982-07d375c9d37b134d.js\",\"344:static/chunks/app/(navbar)/(margined)/post/[...slug]/page-e4edb86238a82fde.js\"],\"name\":\"\",\"async\":false}\n14:T1bb3,"])</script><script>self.__next_f.push([1,"var Component=(()=\u003e{var d=Object.create;var o=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var g=(n,e)=\u003e()=\u003e(e||n((e={exports:{}}).exports,e),e.exports),y=(n,e)=\u003e{for(var s in e)o(n,s,{get:e[s],enumerable:!0})},i=(n,e,s,r)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let a of u(e))!f.call(n,a)\u0026\u0026a!==s\u0026\u0026o(n,a,{get:()=\u003ee[a],enumerable:!(r=p(e,a))||r.enumerable});return n};var b=(n,e,s)=\u003e(s=n!=null?d(m(n)):{},i(e||!n||!n.__esModule?o(s,\"default\",{value:n,enumerable:!0}):s,n)),w=n=\u003ei(o({},\"__esModule\",{value:!0}),n);var h=g(($,l)=\u003e{l.exports=_jsx_runtime});var x={};y(x,{default:()=\u003ev,frontmatter:()=\u003ek});var t=b(h()),k={title:\"Filesystem Snapshots\",author:\"scottyob\",type:\"post\",date:new Date(1300450236e3),url:\"/2011/03/18/3-setting-up-filesystems-and-snapshots/\",categories:[\"FileServer\"],tags:[\"fileserver\",\"ZFS\"]};function c(n){let e=Object.assign({p:\"p\",em:\"em\",pre:\"pre\",code:\"code\",a:\"a\",h3:\"h3\",ol:\"ol\",li:\"li\"},n.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.p,{children:(0,t.jsx)(e.em,{children:\"Note: This post is one in a series aimed to be a tutorial eventually, it\\u2019s not currently finalised and at the moment exists as a place for collating thought and collecting feedback\"})}),`\n`,(0,t.jsx)(e.p,{children:\"Setting up the FileSystems is a trivial task.\\xA0 First, you can see that when we\\u2019ve created a storage pool \\u2018datastore\\u2019 it created a filesystem for us (also called datastore) that can act as a container for child file systems.\\xA0 I\\u2019m going to go ahead and create a place to store my media and downloads now\"}),`\n`,`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/media\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"for now I\\u2019ll also want a place to store my backups.\\xA0 It\\u2019s worth noting that while my media filesystem will contain compressed MP3\\u2019s and the like, it\\u2019s kind of a waste of CPU power to compress it, but my backups will be a lot of PHP pages and what not, so lets go ahead and enable compression on this one\"}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/backups\n`})}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs set compression=on datastore/backups\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"As appalled as I am of my mums backup habits, one of the requirements of this server was to provide a medium for backing up her data without her having to do anything, so lets set up backup locations for my laptop (MacShell) and a place for mum (mum) assigning both of these 20GB quota\\u2019s (ok, MacShell gets 120GB)\"}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# zfs create datastore/backups/MacShell\n# zfs create datastore/backups/mum\n# zfs set quota=120G datastore/backups/MacShell\n# zfs set quota=20GB datastore/backups/mum\n# zfs get datastore/backups/mum\n`})}),`\n`,(0,t.jsxs)(e.p,{children:[\"Now, the idea is that a cron job will run rsyncing over the files every hour, on the hour.\\xA0 For many reasons (in case I get a virus and need to revert back, in case somebody hacks in and does bad stuff, etc, etc) I\\u2019m going to choose to \",(0,t.jsx)(e.a,{href:\"http://docs.huihoo.com/opensolaris/solaris-zfs-administration-guide/html/ch06.html\",children:\"create Snapshots\"}),\" so I can roll back to a previous version.\"]}),`\n`,(0,t.jsx)(e.p,{children:\"The convention I want is hourly.HOUR, daily.DAY, weekly.WEEK for up to 7 days and 4 weeks.\\xA0 This also means that once I delete a file, I won\\u2019t recover the space that it took (once a snapshot of the file has been created) in my data pool until the end of the 4 week period.\\xA0 for instance, hourly.0 will be the last hours snapshot, hourly.1 will be the 2nd last hours snapshot, etc.\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"the following bash script will take care of the desired snapshots.\\xA0 It\\u2019s based on a concept I took from this \",(0,t.jsx)(e.a,{href:\"http://blogs.sun.com/mmusante/entry/rolling_snapshots_made_easy\",children:\"rolling snapshots made easy\"}),\" post but I like \",(0,t.jsx)(e.a,{href:\"/img/old/2011/03/snapshot.sh\",children:\"my scripted way of doing rotating snapshots\"}),\" much better.\"]}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:\"language-bash\",children:`#!/bin/bash\n\n#print out usage\nif [ $# -ne 2 ]\nthen\n  echo \"Usage: snapshot.sh [snapName] [max]\"\n  echo \"  eg. snapshot.sh hour 24\"\nfi\n\n#if the max snapshot already exists, just delete it\nif [ $(zfs list -t snapshot | grep datastore@$1.$2 | wc -l) -eq 1 ]\nthen\n  zfs destroy -r datastore@$1.$2\nfi\n\nfor ((i=$2-1; i \u003e= 0; i--)); do\n  if [ $(zfs list -t snapshot | grep datastore@$1.$i | wc -l) -eq 1 ]\n  then\n    #this snapshot exists, so we want to move it up one\n    zfs rename -r datastore@$1.$i @$1.$[$i+1]\n  fi\ndone\n\nzfs snapshot -r datastore@$1.0\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"so with this snapshot beauty in place, lets say I had an existing file and structure in place\"}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`root@thumper:/datastore/backups/MacShell# pwd\n/datastore/backups/MacShell\nroot@thumper:/datastore/backups/MacShell# tree\n.\n|\\u2013 hello_world.txt\n|\\u2013 someDir\n|- someFile.dat\n\n1 directory, 2 files\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"BUT, I had a snapshot in place\"}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# /snapshot.sh hourly 24\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"then I did something silly like delete my entire backup directory (Oh No!!)\"}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`# rm -R *\n# ls -l\n\ntotal 0\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"never fear! check the snapshots\"}),`\n`,(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:`root@thumper:/datastore/backups/\nMacShell/.zfs/snapshot/hourly.0# tree\n|\\u2013 hello_world.txt\n \\u2013 someDir\n\\`\\u2013 someFile.dat\n`})}),`\n`,(0,t.jsx)(e.p,{children:\"they\\u2019ll eventually roll off my snapshot cycle and be removed in 4 weeks with my plan, but hey, pretty good at this point \\u{1F642}\"}),`\n`,(0,t.jsxs)(e.p,{children:[\"See \",(0,t.jsx)(e.a,{href:\"http://www.scottyob.com/?p=96\",children:\"Part 2\"}),\" for a post on how to set up cron jobs to automatically call this script\"]}),`\n`,(0,t.jsx)(e.h3,{children:\"other posts to come in the series:\"}),`\n`,(0,t.jsxs)(e.ol,{children:[`\n`,(0,t.jsx)(e.li,{children:\"Selecting the hardware\"}),`\n`,(0,t.jsx)(e.li,{children:\"Installing the Operating System\"}),`\n`,(0,t.jsx)(e.li,{children:\"Setting up File systems \u0026 Snapshots\"}),`\n`,(0,t.jsx)(e.li,{children:\"Allowing access through NFS \u0026 SAMBA\"}),`\n`,(0,t.jsx)(e.li,{children:\"Setting up encrypted off-site backups\"}),`\n`,(0,t.jsx)(e.li,{children:\"Configuring Windows \u0026 Linux clients to dump backup info to the FileServer\"}),`\n`,(0,t.jsx)(e.li,{children:\"My router setup, configuring IP tables \u0026 torrents on a low-powered server.\"}),`\n`]})]})}function S(n={}){let{wrapper:e}=n.components||{};return e?(0,t.jsx)(e,Object.assign({},n,{children:(0,t.jsx)(c,n)})):c(n)}var v=S;return w(x);})();\n;return Component;"])</script><script>self.__next_f.push([1,"11:[\"$\",\"article\",null,{\"className\":\"\",\"children\":[\"$\",\"div\",null,{\"className\":\"__className_12746b mb-9\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"__className_df02b7 text-2xl\",\"children\":\"Filesystem Snapshots\"}],[\"$\",\"div\",null,{\"className\":\"text-xs text-gray-400 italic mb-5\",\"children\":[\"Created: \",[\"$\",\"$L12\",null,{\"date\":\"$D2011-03-18T12:10:36.000Z\"}]]}],\"$undefined\",[\"$\",\"div\",null,{\"className\":\"prose lg:prose-lg\",\"children\":[\"$\",\"$L13\",null,{\"code\":\"$14\"}]}]]}]}]\n"])</script></body></html>