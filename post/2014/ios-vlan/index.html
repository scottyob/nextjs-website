<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/2aaf0723e720e8b9-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/42e58f5a516ebb1b-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/8679c800f1e60000-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/d2c70a2e5d6bd385-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/0d26c7c4f71e78d1.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/386fa29998ac6a74.css" data-precedence="next"/><title>Scott O&#x27;Brien</title><meta name="description" content="My online creative outlet"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_0ec1f4"><div class="flex max-w-full w-full flex-col pt-8 pb-8"><div class="self-center w-full"><h1 class="text-center text-4xl __className_baad2a"><a href="/">Scott O&#x27;Brien</a></h1><ul class="flex flex-wrap justify-center space-x-2 text-gray-400 italic pt-3 mb-8 max-w-2xl w-[80%] m-auto __className_6cf34a"><li class="transition group duration-300 whitespace-nowrap"><a href="/">Writings/Projects</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-[70%] bg-orange-500"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/about/">About</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/bucketlist/">Bucket List</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/recipes/">Cooking</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li><li class="transition group duration-300 whitespace-nowrap"><a href="/flying/">Flying</a><span class="block group-hover:max-w-[70%] ml-2 transition-all duration-500 h-0.5 max-w-0 bg-orange-50 group-hover:bg-orange-400"></span></li></ul></div><div class="w-full flex flex-col" id="main-content"><div class="self-center mt-7 max-w-2xl w-[80%]"><article class=""><div class="__className_af3318 mb-9"><h2 class="__className_59b087 text-2xl">Automating VLAN changes for ESXi Switchports in Cisco IOS.</h2><div class="text-xs text-gray-400 italic mb-5">Created: <span>1/29/2014, 10:51:35 AM</span></div><img alt="Post picture" loading="lazy" width="242" height="302" decoding="async" data-nimg="1" class="m-auto mb-5" style="color:transparent" src="/_next/static/media/product_bulletin_cisco_catalyst_6509_enhanced_vertical_chassis-1.07e57352.jpg"/><div class="prose lg:prose-lg"><p>At the organisation I&#x27;m currently working for, we recently experienced <a href="http://www.vspecialist.co.uk/do-my-esxi-hosts-have-the-same-vlans/">what appears to be a common issue</a>, VLAN&#x27;s trunked down to ESXi nodes were inconsistent.</p>
<p>In our DC, we&#x27;re still running the old school Cisco Catalyst switches.  If we were running a fabric, or Nexus switches <a href="http://blog.alwaysthenetwork.com/tutorials/nexus-port-profiles/">we could put port profiles to action</a> or if we lucky enough to have some equipment running Junos ❤️  we could be <a href="http://packetpushers.net/junos-configuration-groups/">using apply-groups for this</a>.</p>
<!-- -->
<p>Being stuck with 6500&#x27;s in the DC as our L2 platform (and a VSS for the L3 MPLS PE) this is a quick little hack job to automate configuration changes across switchports in Cisco IOS based on dynamically finding ports that are matching an interface description.</p>
<p>In our DC, we have a bunch of switches (defined at the top of this script) and all our switchports that go to ESXi switchports that should have this template applied are matched on the interface description containing ‘ESXHOST&#x27;</p>
<p>This relies on the <a href="https://github.com/knipknap/exscript/wiki/Python-API-Tutorial">python EXScript module</a></p>
<pre><code class="language-python"># This script is used for updating the VLANs that are trunked down to ESX boxes.
#  It works by logging in to each switch in the DC then looking at the interfaces that have &#x27;ESXHOST&#x27;
#  in the description.  For each of those switchports, it will run the &#x27;alter&#x27; commands

from Exscript.Account import Account
from Exscript.protocols import SSH2
import argparse
import getopt
import getpass
import sys

#A list of the switches to interigate.  These are the switches that have ESXi hosts in them
SWITCHES = [
    &#x27;10.0.0.2&#x27;,
    &#x27;10.0.0.3&#x27;,
    &#x27;10.0.0.4&#x27;,
    &#x27;10.0.0.5&#x27;,
    &#x27;10.0.0.7&#x27;
    ]

#Commands to execute for every switchport
vlan_commands = &quot;&quot;&quot;
  switchport trunk allowed vlan add 5,10,15,20-25,30,40,50
  switchport trunk allowed vlan add 60,69,70,100-1000
&quot;&quot;&quot;

def query_yes_no(question, default=&quot;yes&quot;):
    &quot;&quot;&quot;Ask a yes/no question via raw_input() and return their answer.

    &quot;question&quot; is a string that is presented to the user.
    &quot;default&quot; is the presumed answer if the user just hits &amp;lt;Enter&amp;gt;.
        It must be &quot;yes&quot; (the default), &quot;no&quot; or None (meaning
        an answer is required of the user).

    The &quot;answer&quot; return value is one of &quot;yes&quot; or &quot;no&quot;.
    &quot;&quot;&quot;
    valid = {&quot;yes&quot;:True,   &quot;y&quot;:True,  &quot;ye&quot;:True,
             &quot;no&quot;:False,     &quot;n&quot;:False}
    if default == None:
        prompt = &quot; [y/n] &quot;
    elif default == &quot;yes&quot;:
        prompt = &quot; [Y/n] &quot;
    elif default == &quot;no&quot;:
        prompt = &quot; [y/N] &quot;
    else:
        raise ValueError(&quot;invalid default answer: &#x27;%s&#x27;&quot; % default)

    while True:
        sys.stdout.write(question + prompt)
        choice = raw_input().lower()
        if default is not None and choice == &#x27;&#x27;:
            return valid[default]
        elif choice in valid:
            return valid[choice]
        else:
            sys.stdout.write(&quot;Please respond with &#x27;yes&#x27; or &#x27;no&#x27; &quot;\
                             &quot;(or &#x27;y&#x27; or &#x27;n&#x27;).\n&quot;)

def returnInterfacesFromShowDescription(text):
    &quot;&quot;&quot;
    Returns a LIST of interfaces from the output of &#x27;show interface desc&#x27; from a cisco device
    &quot;&quot;&quot;
    return [ x.split()[0] for x in text.split(&quot;\n&quot;) ]

def genUpdateConfigForInterfaces(config, interfaces):
    &quot;&quot;&quot;
    Takes in a configuration block to run, a list of interfaces and generates the appropriate int range commands with the
    config block after
    &quot;&quot;&quot;
    updateConfig = &quot;&quot;
    while len(interfaces) &amp;gt; 0:
        updateConfig += &quot;int range &quot; + &quot;,&quot;.join(interfaces[:5])
        interfaces = interfaces[5:]
        updateConfig += &quot;\n  %s\n&quot; % config.strip()
    return updateConfig

def updateSwitchportsWithDescription(switch, description, username, password, commands):
    &quot;&quot;&quot;
    Function is used to log into a switch, find all switchports that CONTAINS the description
    with each of the said switchports, it will then execute the given commands.

    switch:  Device to log into
    description:  Search string to try and find in the switchport description
    username:  Username to log into the switch with
    password:  The password to log into the switch with
    commands:  A list of commands that should be executed
    &quot;&quot;&quot;

    print &quot;Working with switch: %s&quot; % switch

    #establish a SSH connection to the host
    conn = SSH2()
    account = Account(username, password)
    conn.connect(switch)
    conn.login(account)

    #Do some pre-setup
    conn.execute(&#x27;&#x27;)

    #Make sure we&#x27;re in super user mode
    conn.execute(&#x27;enable&#x27;)
    conn.execute(&#x27;terminal length 0&#x27;)

    #find all ports that have ESXHOST (or whatever is set in description) in the description
    conn.execute(&#x27;show int desc | i %s&#x27; % description)
    ports = conn.response.strip()

    print &quot;Ports are:&quot;
    print ports
    portsList = returnInterfacesFromShowDescription(ports)[1:-1]

    #go into config mode and get ready to run the update commands
    #Generate a list of the update commands that should be ran
    updateCommands = genUpdateConfigForInterfaces(commands, portsList).split(&quot;\n&quot;)
    conn.execute(&#x27;conf t&#x27;)
    print conn.response.strip()
    print &quot;! About to execute the following commands.&quot;
    for line in updateCommands:
        print &quot;! &quot; + line

    if query_yes_no(&#x27;Execute Commands?&#x27;, default=&quot;no&quot;):
        #Run the set of commands given
        for command in updateCommands:
            conn.execute(command)
            print conn.response

        #Exit out of config mode
        conn.execute(&quot;exit&quot;)
        conn.execute(&quot;exit&quot;)
        print conn.response
        print

if __name__ == &#x27;__main__&#x27;:
    parser = argparse.ArgumentParser(description=&quot;DC ESX VLAN Utility&quot;)
    parser.add_argument(&#x27;--user&#x27;, help=&#x27;The username that should be used to log into the switches with&#x27;)

    args = parser.parse_args()
    if args.user:
        username = args.user
    else:
        username = getpass.getuser()

    password = getpass.getpass()

    # Generate a list of commands
    for switch in SWITCHES:
        updateSwitchportsWithDescription(switch, &#x27;ESXHOST&#x27;, username, password, vlan_commands)

</code></pre></div></div></article></div></div></div><script src="/_next/static/chunks/webpack-6854f8b189d0947c.js" async=""></script><script src="/_next/static/chunks/bce60fc1-e7cb3874f5f47943.js" async=""></script><script src="/_next/static/chunks/769-64fef319af2abb40.js" async=""></script><script src="/_next/static/chunks/main-app-7c73dbeff8b74fd8.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/2aaf0723e720e8b9-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/42e58f5a516ebb1b-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/media/4e8dfc5aa8742fdc-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/css/0d26c7c4f71e78d1.css\",{\"as\":\"style\"}]\n0:\"$L5\"\n"])</script><script>self.__next_f.push([1,"6:HL[\"/_next/static/media/8679c800f1e60000-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n7:HL[\"/_next/static/media/d2c70a2e5d6bd385-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n8:HL[\"/_next/static/css/386fa29998ac6a74.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"9:I{\"id\":\"8802\",\"chunks\":[\"272:static/chunks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\nb:I{\"id\":\"4299\",\"chunks\":[\"272:static/chunks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\nc:I{\"id\":\"7477\",\"chunks\":[\"477:static/chunks/477-6554af05b281746c.js\",\"153:static/chunks/153-7f7061897db69601.js\",\"651:static/"])</script><script>self.__next_f.push([1,"chunks/651-05a1ce4efc0860d4.js\",\"534:static/chunks/app/flying/location/[slug]/page-65be048863d8522d.js\"],\"name\":\"\",\"async\":false}\nd:I{\"id\":\"5212\",\"chunks\":[\"477:static/chunks/477-6554af05b281746c.js\",\"185:static/chunks/app/layout-9d8f06291be9ea84.js\"],\"name\":\"\",\"async\":false}\nf:I{\"id\":\"3211\",\"chunks\":[\"272:static/chunks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\n10:I{\"id\":\"5767\",\"chunks\":[\"272:static/chu"])</script><script>self.__next_f.push([1,"nks/webpack-6854f8b189d0947c.js\",\"253:static/chunks/bce60fc1-e7cb3874f5f47943.js\",\"769:static/chunks/769-64fef319af2abb40.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0d26c7c4f71e78d1.css\",\"precedence\":\"next\"}]],[\"$\",\"$L9\",null,{\"buildId\":\"7bnD85EgJ3cUdh6-mHFZs\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/2014/ios-vlan/\",\"initialTree\":[\"\",{\"children\":[\"(margined)\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"2014/ios-vlan\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"2014\\\",\\\"ios-vlan\\\"]}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$La\",[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]],\"globalErrorComponent\":\"$b\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_0ec1f4\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_baad2a\",\"children\":[\"$\",\"$Lc\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$Ld\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$Le\",\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}]]}]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_0ec1f4\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex max-w-full w-full flex-col pt-8 pb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"self-center w-full\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-center text-4xl __className_baad2a\",\"children\":[\"$\",\"$Lc\",null,{\"href\":\"/\",\"children\":\"Scott O'Brien\"}]}],[\"$\",\"$Ld\",null,{}]]}],[\"$\",\"div\",null,{\"className\":\"w-full flex flex-col\",\"id\":\"main-content\",\"children\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[[\"$\",\"div\",null,{\"className\":\"self-center mt-7 max-w-2xl w-[80%]\",\"children\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$Lf\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(margined)\",\"children\",\"post\",\"children\",[\"slug\",\"2014/ios-vlan\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$L10\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$L11\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"2014\\\",\\\"ios-vlan\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/386fa29998ac6a74.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"slug\",\"2014/ios-vlan\",\"c\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}]}],null],\"segment\":\"(margined)\"},\"styles\":[]}]}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Scott O'Brien\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"My online creative outlet\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]]\n"])</script><script>self.__next_f.push([1,"12:I{\"id\":\"9114\",\"chunks\":[\"962:static/chunks/962-226f429e9782fad0.js\",\"726:static/chunks/app/(margined)/post/[...slug]/page-063ddffa9c53bc9d.js\"],\"name\":\"\",\"async\":false}\n13:I{\"id\":\"5962\",\"chunks\":[\"962:static/chunks/962-226f429e9782fad0.js\",\"417:static/chunks/app/(margined)/recipes/[slug]/page-0f3a983e02aad0ce.js\"],\"name\":\"\",\"async\":false}\n14:I{\"id\":\"5470\",\"chunks\":[\"91:static/chunks/app/flying/flight/[slug]/page-5440ec33784e9466.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"11:[\"$\",\"article\",null,{\"className\":\"\",\"children\":[\"$\",\"div\",null,{\"className\":\"__className_af3318 mb-9\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"__className_59b087 text-2xl\",\"children\":\"Automating VLAN changes for ESXi Switchports in Cisco IOS.\"}],[\"$\",\"div\",null,{\"className\":\"text-xs text-gray-400 italic mb-5\",\"children\":[\"Created: \",[\"$\",\"$L12\",null,{\"date\":\"$D2014-01-29T10:51:35.000Z\"}]]}],[\"$\",\"$L13\",null,{\"src\":{\"src\":\"/_next/static/media/product_bulletin_cisco_catalyst_6509_enhanced_vertical_chassis-1.07e57352.jpg\",\"height\":302,\"width\":242,\"blurDataURL\":\"data:image/jpeg;base64,/9j/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAIAAYDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAhEAABAwEJAAAAAAAAAAAAAAABAAIDBgQFERMhMTNBkf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwClpNpnr2+xKbUQ3MAEheG8g2x086REQf/Z\",\"blurWidth\":6,\"blurHeight\":8},\"alt\":\"Post picture\",\"className\":\"m-auto mb-5\"}],[\"$\",\"div\",null,{\"className\":\"prose lg:prose-lg\",\"children\":[\"$\",\"$L14\",null,{\"code\":\"var Component=(()=\u003e{var u=Object.create;var i=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var l=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var w=(e,n)=\u003e()=\u003e(n||e((n={exports:{}}).exports,n),n.exports),g=(e,n)=\u003e{for(var o in n)i(e,o,{get:n[o],enumerable:!0})},a=(e,n,o,r)=\u003e{if(n\u0026\u0026typeof n==\\\"object\\\"||typeof n==\\\"function\\\")for(let s of l(n))!f.call(e,s)\u0026\u0026s!==o\u0026\u0026i(e,s,{get:()=\u003en[s],enumerable:!(r=d(n,s))||r.enumerable});return e};var y=(e,n,o)=\u003e(o=e!=null?u(m(e)):{},a(n||!e||!e.__esModule?i(o,\\\"default\\\",{value:e,enumerable:!0}):o,e)),x=e=\u003ea(i({},\\\"__esModule\\\",{value:!0}),e);var h=w((k,c)=\u003e{c.exports=_jsx_runtime});var C={};g(C,{default:()=\u003ev,frontmatter:()=\u003eS});var t=y(h()),S={title:\\\"Automating VLAN changes for ESXi Switchports in Cisco IOS.\\\",author:\\\"scottyob\\\",type:\\\"post\\\",date:new Date(1390992695e3),url:\\\"/2014/01/29/automating-vlan-changes-for-esxi-switchports-in-cisco-ios/\\\",categories:[\\\"Uncategorized\\\"],hero:\\\"product_bulletin_cisco_catalyst_6509_enhanced_vertical_chassis-1.jpg\\\"};function p(e){let n=Object.assign({p:\\\"p\\\",a:\\\"a\\\",pre:\\\"pre\\\",code:\\\"code\\\"},e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:[\\\"At the organisation I'm currently working for, we recently experienced \\\",(0,t.jsx)(n.a,{href:\\\"http://www.vspecialist.co.uk/do-my-esxi-hosts-have-the-same-vlans/\\\",children:\\\"what appears to be a common issue\\\"}),\\\", VLAN's trunked down to ESXi nodes were inconsistent.\\\"]}),`\\n`,(0,t.jsxs)(n.p,{children:[\\\"In our DC, we're still running the old school Cisco Catalyst switches. \\\\xA0If we were running a fabric, or Nexus switches \\\",(0,t.jsx)(n.a,{href:\\\"http://blog.alwaysthenetwork.com/tutorials/nexus-port-profiles/\\\",children:\\\"we could put port profiles\\\\xA0to action\\\"}),\\\"\\\\xA0or if we lucky enough to have some equipment running Junos \\\\u2764\\\\uFE0F  we could be \\\",(0,t.jsx)(n.a,{href:\\\"http://packetpushers.net/junos-configuration-groups/\\\",children:\\\"using apply-groups for this\\\"}),\\\".\\\"]}),`\\n`,`\\n`,(0,t.jsx)(n.p,{children:\\\"Being stuck with 6500's in the DC as our L2 platform (and a VSS for the L3 MPLS PE) this is a quick little hack job to automate configuration changes across switchports in Cisco IOS based on dynamically finding ports that are matching an interface description.\\\"}),`\\n`,(0,t.jsx)(n.p,{children:\\\"In our DC, we have a bunch of switches (defined at the top of this script) and all our switchports that go to ESXi switchports that should have this template applied are matched on the interface description containing \\\\u2018ESXHOST'\\\"}),`\\n`,(0,t.jsxs)(n.p,{children:[\\\"This relies on the \\\",(0,t.jsx)(n.a,{href:\\\"https://github.com/knipknap/exscript/wiki/Python-API-Tutorial\\\",children:\\\"python EXScript module\\\"})]}),`\\n`,(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:\\\"language-python\\\",children:`# This script is used for updating the VLANs that are trunked down to ESX boxes.\\n#  It works by logging in to each switch in the DC then looking at the interfaces that have 'ESXHOST'\\n#  in the description.  For each of those switchports, it will run the 'alter' commands\\n\\nfrom Exscript.Account import Account\\nfrom Exscript.protocols import SSH2\\nimport argparse\\nimport getopt\\nimport getpass\\nimport sys\\n\\n#A list of the switches to interigate.  These are the switches that have ESXi hosts in them\\nSWITCHES = [\\n    '10.0.0.2',\\n    '10.0.0.3',\\n    '10.0.0.4',\\n    '10.0.0.5',\\n    '10.0.0.7'\\n    ]\\n\\n#Commands to execute for every switchport\\nvlan_commands = \\\"\\\"\\\"\\n  switchport trunk allowed vlan add 5,10,15,20-25,30,40,50\\n  switchport trunk allowed vlan add 60,69,70,100-1000\\n\\\"\\\"\\\"\\n\\ndef query_yes_no(question, default=\\\"yes\\\"):\\n    \\\"\\\"\\\"Ask a yes/no question via raw_input() and return their answer.\\n\\n    \\\"question\\\" is a string that is presented to the user.\\n    \\\"default\\\" is the presumed answer if the user just hits \u0026lt;Enter\u0026gt;.\\n        It must be \\\"yes\\\" (the default), \\\"no\\\" or None (meaning\\n        an answer is required of the user).\\n\\n    The \\\"answer\\\" return value is one of \\\"yes\\\" or \\\"no\\\".\\n    \\\"\\\"\\\"\\n    valid = {\\\"yes\\\":True,   \\\"y\\\":True,  \\\"ye\\\":True,\\n             \\\"no\\\":False,     \\\"n\\\":False}\\n    if default == None:\\n        prompt = \\\" [y/n] \\\"\\n    elif default == \\\"yes\\\":\\n        prompt = \\\" [Y/n] \\\"\\n    elif default == \\\"no\\\":\\n        prompt = \\\" [y/N] \\\"\\n    else:\\n        raise ValueError(\\\"invalid default answer: '%s'\\\" % default)\\n\\n    while True:\\n        sys.stdout.write(question + prompt)\\n        choice = raw_input().lower()\\n        if default is not None and choice == '':\\n            return valid[default]\\n        elif choice in valid:\\n            return valid[choice]\\n        else:\\n            sys.stdout.write(\\\"Please respond with 'yes' or 'no' \\\"\\\\\\\\\\n                             \\\"(or 'y' or 'n').\\\\\\\\n\\\")\\n\\ndef returnInterfacesFromShowDescription(text):\\n    \\\"\\\"\\\"\\n    Returns a LIST of interfaces from the output of 'show interface desc' from a cisco device\\n    \\\"\\\"\\\"\\n    return [ x.split()[0] for x in text.split(\\\"\\\\\\\\n\\\") ]\\n\\ndef genUpdateConfigForInterfaces(config, interfaces):\\n    \\\"\\\"\\\"\\n    Takes in a configuration block to run, a list of interfaces and generates the appropriate int range commands with the\\n    config block after\\n    \\\"\\\"\\\"\\n    updateConfig = \\\"\\\"\\n    while len(interfaces) \u0026gt; 0:\\n        updateConfig += \\\"int range \\\" + \\\",\\\".join(interfaces[:5])\\n        interfaces = interfaces[5:]\\n        updateConfig += \\\"\\\\\\\\n  %s\\\\\\\\n\\\" % config.strip()\\n    return updateConfig\\n\\ndef updateSwitchportsWithDescription(switch, description, username, password, commands):\\n    \\\"\\\"\\\"\\n    Function is used to log into a switch, find all switchports that CONTAINS the description\\n    with each of the said switchports, it will then execute the given commands.\\n\\n    switch:  Device to log into\\n    description:  Search string to try and find in the switchport description\\n    username:  Username to log into the switch with\\n    password:  The password to log into the switch with\\n    commands:  A list of commands that should be executed\\n    \\\"\\\"\\\"\\n\\n    print \\\"Working with switch: %s\\\" % switch\\n\\n    #establish a SSH connection to the host\\n    conn = SSH2()\\n    account = Account(username, password)\\n    conn.connect(switch)\\n    conn.login(account)\\n\\n    #Do some pre-setup\\n    conn.execute('')\\n\\n    #Make sure we're in super user mode\\n    conn.execute('enable')\\n    conn.execute('terminal length 0')\\n\\n    #find all ports that have ESXHOST (or whatever is set in description) in the description\\n    conn.execute('show int desc | i %s' % description)\\n    ports = conn.response.strip()\\n\\n    print \\\"Ports are:\\\"\\n    print ports\\n    portsList = returnInterfacesFromShowDescription(ports)[1:-1]\\n\\n    #go into config mode and get ready to run the update commands\\n    #Generate a list of the update commands that should be ran\\n    updateCommands = genUpdateConfigForInterfaces(commands, portsList).split(\\\"\\\\\\\\n\\\")\\n    conn.execute('conf t')\\n    print conn.response.strip()\\n    print \\\"! About to execute the following commands.\\\"\\n    for line in updateCommands:\\n        print \\\"! \\\" + line\\n\\n    if query_yes_no('Execute Commands?', default=\\\"no\\\"):\\n        #Run the set of commands given\\n        for command in updateCommands:\\n            conn.execute(command)\\n            print conn.response\\n\\n        #Exit out of config mode\\n        conn.execute(\\\"exit\\\")\\n        conn.execute(\\\"exit\\\")\\n        print conn.response\\n        print\\n\\nif __name__ == '__main__':\\n    parser = argparse.ArgumentParser(description=\\\"DC ESX VLAN Utility\\\")\\n    parser.add_argument('--user', help='The username that should be used to log into the switches with')\\n\\n    args = parser.parse_args()\\n    if args.user:\\n        username = args.user\\n    else:\\n        username = getpass.getuser()\\n\\n    password = getpass.getpass()\\n\\n    # Generate a list of commands\\n    for switch in SWITCHES:\\n        updateSwitchportsWithDescription(switch, 'ESXHOST', username, password, vlan_commands)\\n\\n`})})]})}function _(e={}){let{wrapper:n}=e.components||{};return n?(0,t.jsx)(n,Object.assign({},e,{children:(0,t.jsx)(p,e)})):p(e)}var v=_;return x(C);})();\\n;return Component;\"}]}]]}]}]\n"])</script></body></html>